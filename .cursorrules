# PSO Design System Rules

## Related Projects

When referencing patterns from other Coinflipper apps, agents may look at these sibling directories:

- `../CoinflipperLogin` - Coinflipper login service and identity management app
- `../pickahit` - MLB postseason picks pool app
- `../SubContest` - NFL picks pool app
- `../SummerClassics` — MLB picks pool app

## Project Maturity

This codebase is deployed but not yet battle-tested through a real fantasy season. Most features haven't been used by real users yet. This means:

- **Refactoring is cheap** — No established user habits to break
- **Experimentation is encouraged** — Try the cleaner approach, iterate freely
- **Debt avoidance matters** — Better to get paradigms right now than accumulate workarounds
- **New patterns welcome** — Don't shy away from rethinking UI/UX or data models

Treat this as shaping-phase code, not legacy code.

## Development Workflow

The app runs in Docker. Changes to Pug templates (`views/`) and static files (`public/`) are picked up automatically — no container restart needed. Only restart (`docker compose restart web`) when changing JavaScript files (routes, services, helpers, models).

## Design System

This project uses Pug templates with a design system of shared mixins, helpers, and CSS tokens. Follow these conventions when creating or modifying views.

## View Helpers (available globally in Pug)

All helpers are available directly in templates (e.g., `formatMoney(1234)`):

- `formatMoney(n, options?)` — Format currency with `$` sign. Options: `{ sign: '+' | '-' | 'auto' }`
  - `formatMoney(500)` → `$500`
  - `formatMoney(500, { sign: '+' })` → `+$500`
  - `formatMoney(-163, { sign: 'auto' })` → `-$163`
- `formatRecord(w, l, t?)` — Format win-loss record: `10-5` or `10-5-1`
- `formatPoints(n)` — Format with 2 decimal places and commas
- `formatScore(n)` — Alias for formatPoints
- `formatContractYears(start, end)` — Format as `23/26`, `FA/26`, or `unsigned`
- `formatDateISO(d)` — Format as `YYYY-MM-DD`
- `ordinal(n)` — Returns `1st`, `2nd`, `3rd`, etc.
- `deltaClass(n)` — Returns `text-success`, `text-danger`, or `text-muted` based on sign
- `sortedPositions(positions)` — Sort position array by standard order (QB, RB, WR, TE, DL, LB, DB, K)
- `getPositionKey(player)` — Get sorted position string like `RB/WR`

## Pug Mixins (in views/mixins.pug)

Include mixins at top of template: `include mixins`

### Position Badge
```pug
+positionBadge(['QB'])
+positionBadge(['RB', 'WR'])
```

### Status Badge
```pug
+statusBadge('pending')
+statusBadge('accepted', 'approved')  //- custom display text
```
Statuses: hypothetical, pending, accepted, rejected, canceled, expired, executed

**Terminology notes**:
- Use "hypothetical" (not "draft") for uncommitted trade proposals
- Use "cancel" (not "withdraw") for the action of canceling a proposal
- The model is `Proposal` (not `TradeProposal`), stored in the `proposals` collection

### Alert Banner
```pug
//- Simple message (text parameter)
+alertBanner('danger', 'fa-times-circle', 'This proposal was rejected.').mb-4

//- Complex content (block)
+alertBanner('success', 'fa-check').mb-4
  | This trade has been executed.
  if proposal.executedTransactionId
    |  
    a(href='/trades/' + id) View in trade history →
```
Types: danger, warning, success, info, secondary

For client-side JS, use the `#alert-banner-template` template element and clone it.

### Season Navigation
```pug
+seasonNav(currentSeason, quickSeasons, olderSeasons, olderLabel)
+seasonNav(2025, [2023, 2024, 2025], [2020, 2021, 2022], 'Past Drafts')
```

### Trade Assets
```pug
//- Single asset
+tradeAsset({ type: 'player', playerName: 'Josh Allen', positions: ['QB'], contractInfo: '22/26' })
+tradeAsset({ type: 'pick', pickMain: '2025 1st', pickContext: '(from Schex)' })
+tradeAsset({ type: 'cash', cashMain: '$500', cashContext: 'in 2025' })
+tradeAsset({ type: 'rfa', playerName: 'Cooper Kupp', positions: ['WR'], contractInfo: 'RFA rights' })
+tradeAsset({ type: 'nothing', display: 'Nothing' })

//- Full party with assets
+tradeParty({ franchiseName: 'Schex', usePlural: false, assets: [...] })
```

### Budget Impact Table
```pug
+budgetImpactTable([
  { franchiseName: 'Schex', seasons: [{ season: 2025, delta: -500 }, { season: 2026, delta: -163 }] },
  { franchiseName: 'Koci', seasons: [{ season: 2025, delta: 500 }, { season: 2026, delta: 163 }] }
])
```

### Page Titles
Use the `+title()` mixin for hierarchical breadcrumb-style titles:
```pug
block title
  +title('Page Name', 'Section', 'Parent Section')
```

**Breadcrumb order**: Most specific → most general (left to right), ending with "Primetime Soap Operas"

**Examples**:
```pug
//- Standalone page
+title('Trade Machine')

//- Section page
+title('Trade History')

//- Detail within section
+title('Trade #' + tradeNumber, 'Trade History')

//- Item within section
+title(franchise.displayName, 'Franchises')

//- Nested admin page
+title(player.name, 'Players', 'Admin')
```

**Guidelines**:
- Views define their own titles using `block title`
- Dynamic parts use data already passed to the view (e.g., `franchise.displayName`, `player.name`)
- Controllers should NOT pass `pageTitle` — the view handles title generation
- Include parent sections to create navigational hierarchy

## CSS Files

Include in `block styles` as needed:

```pug
block styles
  link(rel='stylesheet' href='/css/positions.css')   //- for +positionBadge
  link(rel='stylesheet' href='/css/components.css')  //- for status badges, trade assets, season nav, card footer links
```

Note: `design-tokens.css` is already included globally via layout.pug.

## CSS Conventions

### Naming: BEM (Block Element Modifier)

Use BEM naming to scope styles and prevent class name collisions:

```css
/* Block: standalone component */
.trade-filter { }

/* Element: part of a block (double underscore) */
.trade-filter__section { }
.trade-filter__title { }

/* Modifier: variation of block/element (double hyphen) */
.trade-filter--sticky { }
.trade-filter__section--highlighted { }
```

### Where Styles Live

| Type | Location | Naming |
|------|----------|--------|
| **Design tokens** | `design-tokens.css` | CSS custom properties (`--pos-qb-bg`) |
| **Shared components** | `components.css` | BEM blocks (`.status-badge`, `.asset-list`) |
| **Position styles** | `positions.css` | `.pos-{position}` pattern |
| **Navigation** | `sidebar.css` | BEM with `nav-` prefix |
| **Page-specific** | `public/css/{page}.css` | BEM with page prefix (`.trade-filter`, `.draft-board`) |

Page-specific CSS files follow the template name: `proposal.pug` → `proposal.css`, `admin-players.pug` → `admin-players.css`, etc.

### Avoid

- Inline `style.` blocks in templates (extract to CSS files)
- Generic class names that could collide (`.sidebar`, `.section`, `.title`, `.card`)
- Deep nesting beyond Block > Element (no `.a__b__c`)
- Modifiers without the base class
- Writing custom CSS that targets Bootstrap classes directly (e.g., `.card-footer { ... }`). Use Bootstrap classes as-is, but when custom styling is needed, add a BEM-namespaced class alongside (e.g., `.proposal-actions`) and target that instead.

## Design Tokens (CSS Custom Properties)

Use these instead of hardcoded colors:

### Position Colors
- `--pos-qb-bg`, `--pos-qb-text`
- `--pos-rb-bg`, `--pos-rb-text`
- `--pos-wr-bg`, `--pos-wr-text`
- `--pos-te-bg`, `--pos-te-text`
- `--pos-idp-bg`, `--pos-idp-text` (also used for DL, LB, DB)
- `--pos-k-bg`, `--pos-k-text`

### Asset Type Colors
- `--asset-player` (green)
- `--asset-pick` (blue)
- `--asset-cash` (gold)
- `--asset-rfa` (purple)
- `--asset-nothing` (gray)

### Status Colors
- `--status-{status}-bg`, `--status-{status}-text`
- Statuses: hypothetical, pending, accepted, rejected, canceled, expired, executed

### UI Colors
- `--color-success`, `--color-danger`, `--color-warning`, `--color-info`, `--color-disabled`
- `--border-light`, `--border-muted`
- `--text-muted`, `--text-secondary`, `--text-tertiary`

## Component Library

Visit `/components` to see a live showcase of all mixins and design tokens.

## Route Conventions

### Trade-Related Routes

| Feature | Route | Model/Service |
|---------|-------|---------------|
| Trade Machine | `/trade-machine` | `proposals/service.js` |
| Proposals (in-flight) | `/proposals/:slug` | `Proposal` model |
| Trade History | `/trades` | `Transaction` model (executed trades) |
| Single Trade | `/trades/:id` | `Transaction` model |

**Key distinction**: A "proposal" is a trade in negotiation. A "trade" (or "transaction") is an executed, permanent record.

## Patterns

### Money Formatting
Always use `formatMoney()` — never manually prepend `$`:
```pug
//- Good
| #{formatMoney(player.salary)}
| #{formatMoney(delta, { sign: 'auto' })}

//- Bad
| $#{player.salary}
```

### Position Badges
Use the mixin instead of inline styling:
```pug
//- Good
+positionBadge(player.positions)

//- Bad
span.badge(style='background: #D7EBFF; color: #1a5276')= player.positions.join('/')
```

### Contract Display
Use the helper for consistent formatting:
```pug
//- Good
| #{formatContractYears(player.startYear, player.endYear)}

//- Bad
| #{player.startYear % 100}/#{player.endYear % 100}
```

### Card Footer Links
For cards/widgets that link to a detailed view, use `.card-footer-link`:
```pug
a.card-footer-link(href='/calendar')
  span View Full Calendar
  i.fa.fa-chevron-right
```
This creates a full-width clickable footer with hover state. Used on the homepage for calendar widget and franchise cards.
