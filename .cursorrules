# PSO Design System Rules

## Related Projects

When referencing patterns from other Coinflipper apps, agents may look at these sibling directories:

- `../CoinflipperLogin` - Coinflipper login service and identity management app
- `../pickahit` - MLB postseason picks pool app
- `../SubContest` - NFL picks pool app
- `../SummerClassics` — MLB picks pool app

## Project Maturity

This codebase is deployed but not yet battle-tested through a real fantasy season. Most features haven't been used by real users yet. This means:

- **Refactoring is cheap** — No established user habits to break
- **Experimentation is encouraged** — Try the cleaner approach, iterate freely
- **Debt avoidance matters** — Better to get paradigms right now than accumulate workarounds
- **New patterns welcome** — Don't shy away from rethinking UI/UX or data models

Treat this as shaping-phase code, not legacy code.

## Data & Domain Modeling

When working on data transformations, seeding scripts, or inference logic (especially in `data/dsl/`, `data/seed/`, `data/archive/`):

- **Ask before inferring.** If the code needs to make assumptions about what data means (e.g., "what does an empty owner field imply?", "when should we generate an FA transaction?"), stop and ask the user to explain the business rules before implementing.

- **Don't reverse-engineer domain logic from errors.** If running code produces unexpected results, that's often a sign the underlying rules weren't understood. Ask about the rules rather than patching symptoms.

- **The user knows the league history.** This is a 15+ year fantasy league with complex ownership transitions, defunct franchises, and historical edge cases. The user can explain what *should* happen faster than the code can discover it.

- **Sleeper ID is the only reliable player identifier.** Do NOT use ESPN IDs for any serious logic or matching. ESPN IDs exist in some historical data as a supplement but are not authoritative. Use `sleeperId` (or its absence for pre-Sleeper historical players) as the sole basis for player identity decisions.

## Development Workflow

The app runs in Docker. Changes to Pug templates (`views/`) and static files (`public/`) are picked up automatically — no container restart needed. Only restart (`docker compose restart web`) when changing JavaScript files (routes, services, helpers, models).

**Local dev is HTTPS-only.** Use `https://localhost:9528` — plain HTTP will not work. When testing with curl, use `curl -sk` to skip certificate validation.

## Design System

This project uses Pug templates with a design system of shared mixins, helpers, and CSS tokens. Follow these conventions when creating or modifying views.

## View Helpers (available globally in Pug)

All helpers are available directly in templates (e.g., `formatMoney(1234)`):

- `formatMoney(n, options?)` — Format currency with `$` sign. Options: `{ sign: '+' | '-' | 'auto' }`
  - `formatMoney(500)` → `$500`
  - `formatMoney(500, { sign: '+' })` → `+$500`
  - `formatMoney(-163, { sign: 'auto' })` → `-$163`
- `formatRecord(w, l, t?)` — Format win-loss record: `10-5` or `10-5-1`
- `formatPoints(n)` — Format with 2 decimal places and commas
- `formatContractYears(start, end)` — Format as `23/26`, `FA/26`, or `unsigned`
- `formatDateISO(d)` — Format as `YYYY-MM-DD`
- `ordinal(n)` — Returns `1st`, `2nd`, `3rd`, etc.
- `deltaClass(n)` — Returns `text-success`, `text-danger`, or `text-muted` based on sign
- `sortedPositions(positions)` — Sort position array by standard order (QB, RB, WR, TE, DL, LB, DB, K)
- `getPositionKey(player)` — Get sorted position string like `RB/WR`

## Pug Mixins (in views/mixins.pug)

Include mixins at top of template: `include mixins`

### Position Badge
```pug
+positionBadge(['QB'])
+positionBadge(['RB', 'WR'])
```

### Status Badge
```pug
+statusBadge('pending')
+statusBadge('accepted', 'approved')  //- custom display text
```
Statuses: hypothetical, pending, accepted, rejected, canceled, expired, executed

**Terminology notes**:
- Use "hypothetical" (not "draft") for uncommitted trade proposals
- Use "cancel" (not "withdraw") for the action of canceling a proposal
- The model is `Proposal` (not `TradeProposal`), stored in the `proposals` collection

### Season Tile
```pug
//- With playoff finish styling (default)
+seasonTile({ season: 2024, wins: 13, losses: 2, playoffFinish: 'champion' })
+seasonTile({ season: 2023, wins: 10, losses: 5, madePlayoffs: true })
+seasonTile({ season: 2022, wins: 6, losses: 9 })

//- With custom color (overrides playoff styling)
+seasonTile({ season: 2024 }, { color: '#4a90d9', href: '/franchises/1/schedule/2024' })

//- With size variants
+seasonTile({ season: 2024 }, { color: '#4a90d9', size: 'sm' })  //- 10px
+seasonTile({ season: 2024 }, { color: '#4a90d9', size: 'lg' })  //- 18px

//- With extra classes and data attributes (for JS interactivity)
+seasonTile({ season: 2024 }, { color: '#4a90d9', class: 'past-owner', data: { franchise: '1' } })
```
Result object: `{ season, wins?, losses?, playoffFinish?, madePlayoffs? }`
- `playoffFinish`: 'champion', 'runner-up', 'third-place', or null
- If wins/losses provided, they appear in tooltip; otherwise just the year

Options:
- `href` — makes tile a link
- `color` — override background color (bypasses playoff styling)
- `size` — 'sm' (10px), 'lg' (18px), or default (14px)
- `title` — override tooltip text
- `class` — additional CSS classes (string)
- `data` — object of data-* attributes (e.g., `{ franchise: '1' }` → `data-franchise="1"`)

### Alert Banner
```pug
//- Simple message (text parameter)
+alertBanner('danger', 'fa-times-circle', 'This proposal was rejected.').mb-4

//- Complex content (block)
+alertBanner('success', 'fa-check').mb-4
 | This trade has been executed.
 if proposal.executedTransactionId
 | 
 a(href='/trades/' + id) View in trade history →
```
Types: danger, warning, success, info, secondary

### Player Chip
```pug
//- Basic player with contract info
+playerChip({ name: 'Josh Allen', positions: ['QB'], detail: '$44 · 22/26' })

//- RFA variant (dashed purple border)
+playerChip({ name: 'Cooper Kupp', positions: ['WR'], detail: 'Schex', variant: 'rfa' })

//- With link
+playerChip({ name: 'Lamar Jackson', positions: ['QB'], detail: '$40 · 23/26', href: '/players/123' })
```
Options:
- `name` — player name (required)
- `positions` — array of positions for coloring and badge
- `detail` — secondary text (salary, contract, franchise name, etc.)
- `href` — makes the chip a clickable link
- `variant` — `'rfa'` for dashed purple styling

Use `.player-chip-grid` container class for responsive grid layout.

### Matchup (Game Result)
```pug
//- Upcoming game (no scores)
+matchup({ away: { name: 'Schex', record: '8-3' }, home: { name: 'Koci', record: '7-4' } })

//- Completed game with scores
+matchup({ away: { name: 'Schex', score: 142.56, record: '9-3', won: true }, home: { name: 'Koci', score: 128.34, record: '7-5' } })

//- Playoff game with seeds and label
+matchup({ away: { name: 'Schex', score: 156.78, seed: 2, won: true }, home: { name: 'Nance', score: 142.12, seed: 3 }, type: 'semifinal' }, { label: 'Semifinal 1' })

//- Championship (special styling)
+matchup({ away: {...}, home: {...}, type: 'championship' }, { label: 'Championship' })

//- With subtitle (for franchise name + regime display)
+matchup({ away: { name: 'Franchise 9', subtitle: 'Schexes', score: 156.78, won: true }, home: { name: 'Franchise 1', subtitle: 'Patrick & Mike', score: 142.12 }, type: 'championship' }, { label: 'Championship' })
```
Game types: regular (default), semifinal, championship, thirdPlace
Options: `{ label: 'Label Text' }` - display a label above the matchup

The matchup component uses **container queries**:
- Records hidden below 230px, shown inline when there's room
- Subtitles always visible on their own line

This allows the same component to work in sidebar widgets and full-width schedule pages.

### Standings Table
```pug
//- Basic widget (compact, for homepage cards)
+standingsTable(teams, { variant: 'widget' })

//- Sidebar (with all-play column, for schedule page)
+standingsTable(teams, { variant: 'sidebar', userTeamIds: userFranchiseIds })

//- Full (all columns, for main standings page)
+standingsTable(teams, { variant: 'full', isFinal: true, showMedals: true, showPlayoffStats: true })

//- Mini (minimal, for division breakdowns)
+standingsTable(divisionTeams, { variant: 'mini', showCutoff: false })
```
Variants: widget, sidebar, full, mini
Options:
- `variant` - which column set to use (default: 'widget')
- `userTeamId` - single franchise ID to highlight as user's team
- `userTeamIds` - array of franchise IDs to highlight (for multi-franchise users)
- `userTeamName` - team name string to highlight
- `showMedals` - show gold/silver/bronze for top 3 (requires `isFinal: true`)
- `showCutoff` - show playoff cutoff line after 4th place (default: true)
- `showPlayoffStats` - show playoff stats under regular stats
- `isFinal` - indicates final standings (enables medals)

The standings table uses **container queries** to progressively hide columns:
- Full: hides Stern → PA/Diff → All-Play as width shrinks
- Sidebar: hides PA → All-Play as width shrinks
- Widget: hides PA at narrow widths

For client-side JS, use the `#alert-banner-template` template element and clone it.

### Sequential Navigation
```pug
//- Simple mode: prev/next arrows with current label (for paginated views)
+sequentialNav({ prev: prevId, next: nextId, current: 'Trade #43', urlPattern: '/trades/' })

//- Dropdown mode: arrows with dropdown selector (no quickItems)
+sequentialNav({ items: [2020, 2021, 2022, 2023, 2024, 2025], current: 2024, urlPattern: '/schedule/' })

//- Pills mode: arrows with quick pills and optional jump dropdown
+sequentialNav({ items: allSeasons, current: 2024, quickItems: [2022, 2023, 2024, 2025], jumpLabel: 'Older...', urlPattern: '/standings/' })
```
Options:
- `items` — full list of values for dropdown/pills modes
- `current` — currently selected value (or label for simple mode)
- `prev`, `next` — direct URLs for simple mode (bypasses items)
- `urlPattern` — URL prefix (value appended, or empty string if prev/next are full URLs)
- `urlSuffix` — optional suffix after value
- `quickItems` — subset to show as pills (enables pills mode)
- `jumpLabel` — label for dropdown containing non-quick items
- `labelFn` — transform values for display (e.g., `v => 'Week ' + v`)

### Trade Assets
```pug
//- Single asset
+tradeAsset({ type: 'player', playerName: 'Josh Allen', positions: ['QB'], contractInfo: '22/26' })
+tradeAsset({ type: 'pick', pickMain: '2025 1st', pickContext: '(from Schex)' })
+tradeAsset({ type: 'cash', cashMain: '$500', cashContext: 'in 2025' })
+tradeAsset({ type: 'rfa', playerName: 'Cooper Kupp', positions: ['WR'], contractInfo: 'RFA rights' })
+tradeAsset({ type: 'nothing', display: 'Nothing' })

//- Full party with assets
+tradeParty({ franchiseName: 'Schex', usePlural: false, assets: [...] })
```

### Data Table
General-purpose styled table (CSS class, not a mixin):
```pug
table.data-table
  thead
    tr
      th Column 1
      th Column 2
  tbody
    tr
      td Value 1
      td Value 2
```
Variants:
- `.data-table--bordered` — full cell borders with alternating row colors
- `.data-table--compact` — smaller padding and font size
- Add `.data-table__num` to cells for right-aligned tabular numbers

### Budget Impact Table
```pug
+budgetImpactTable([
  { franchiseName: 'Schex', seasons: [{ season: 2025, delta: -500 }, { season: 2026, delta: -163 }] },
  { franchiseName: 'Koci', seasons: [{ season: 2025, delta: 500 }, { season: 2026, delta: 163 }] }
])
```

### Page Titles
Use the `+title()` mixin for hierarchical breadcrumb-style titles:
```pug
block title
  +title('Page Name', 'Section', 'Parent Section')
```

**Breadcrumb order**: Most specific → most general (left to right), ending with "Primetime Soap Operas"

**Examples**:
```pug
//- Standalone page
+title('Trade Machine')

//- Section page
+title('Trade History')

//- Detail within section
+title('Trade #' + tradeNumber, 'Trade History')

//- Item within section
+title(franchise.displayName, 'Franchises')

//- Nested admin page
+title(player.name, 'Players', 'Admin')
```

**Guidelines**:
- Views define their own titles using `block title`
- Dynamic parts use data already passed to the view (e.g., `franchise.displayName`, `player.name`)
- Controllers should NOT pass `pageTitle` — the view handles title generation
- Include parent sections to create navigational hierarchy

## CSS Files

Include in `block styles` as needed:

```pug
block styles
  link(rel='stylesheet' href='/css/positions.css')   //- for +positionBadge
```

Note: `design-tokens.css` and `components.css` are already included globally via layout.pug.

## CSS Conventions

### Naming: BEM (Block Element Modifier)

Use BEM naming to scope styles and prevent class name collisions:

```css
/* Block: standalone component */
.trade-filter { }

/* Element: part of a block (double underscore) */
.trade-filter__section { }
.trade-filter__title { }

/* Modifier: variation of block/element (double hyphen) */
.trade-filter--sticky { }
.trade-filter__section--highlighted { }
```

### Where Styles Live

| Type | Location | Naming |
|------|----------|--------|
| **Design tokens** | `design-tokens.css` | CSS custom properties (`--pos-qb-bg`) |
| **Shared components** | `components.css` | BEM blocks (`.status-badge`, `.asset-list`) |
| **Position styles** | `positions.css` | `.pos-{position}` pattern |
| **Navigation** | `sidebar.css` | BEM with `nav-` prefix |
| **Page-specific** | `public/css/{page}.css` | BEM with page prefix (`.trade-filter`, `.draft-board`) |

Page-specific CSS files follow the template name: `proposal.pug` → `proposal.css`, `admin-players.pug` → `admin-players.css`, etc.

## Page Layouts

Use these standardized layout patterns for consistent page structure.

### Layout Types

| Layout | Container | When to Use |
|--------|-----------|-------------|
| **Standard** | `.container.py-4` | Most pages — content has a natural max-width |
| **Wide** | `.container-fluid.py-4` | Multi-column grids that benefit from horizontal expansion |
| **Hero** | Hero section + `.container.py-4` | Entity detail pages (player, franchise) |

**Standard** is the default. Use **Wide** only when you have multiple independent columns that should expand with the viewport (e.g., league dashboard with card widgets, franchises grid, schedule with games + standings sidebar).

### Hero Pattern

For entity detail pages (player, franchise), use a hero section outside the main content container:

```pug
//- Hero section (outside main container)
div.player-hero(class='player-hero--' + primaryPos)
  div.container
    div.player-hero__layout
      //- Hero content (badge, name, meta)

//- Main content (separate container with padding)
div.container.py-4
  div.row
    //- Page content
```

Hero CSS conventions:
- `padding: 1.5rem 0` — vertical padding
- `margin-bottom: 0` — let the following container's `py-4` handle spacing
- `border-bottom` — visual separator (3px colored for player, 1px subtle for franchise)
- Hero h1 inherits base typography (2rem desktop / 1.75rem mobile)

### Page Header Pattern

Use `.page-header` for consistent page titles:

```pug
div.page-header
  h1 Page Title
```

The centered variant (`.page-header--centered`) is reserved for the main League Overview page only.

### Page Navigation Pattern

When a page has season/week navigation below the title, use `.page-nav`:

```pug
div.page-header
  h1 #{season} Standings
div.page-nav.mb-4
  +sequentialNav({ items: allSeasons, current: season, urlPattern: '/standings/' })
```

Multiple navs can be placed in the same `.page-nav` container:

```pug
div.page-nav.mb-4
  +sequentialNav({ items: allSeasons, current: season, urlPattern: '/schedule/', urlSuffix: '/' + week })
  +sequentialNav({ items: weekNumbers, current: week, urlPattern: '/schedule/' + season + '/' })
```

### Complete Layout Examples

```pug
//- Standard page (most pages)
block content
  div.container.py-4
    div.page-header
      h1 #{season} Standings
    div.page-nav.mb-4
      +sequentialNav(...)
    div.row
      div.col-lg-10.col-xl-8
        //- Content...

//- Wide page (multi-column grids)
block content
  div.container-fluid.py-4
    div.page-header
      h1 Franchises
    div.row
      each franchise in franchises
        div.col-md-6.col-lg-4.col-xl-3.mb-4
          +franchiseCard(franchise)

//- Hero page (entity detail)
block content
  div.player-hero
    div.container
      //- Hero content...
  div.container.py-4
    div.row
      div.col-lg-7
        //- Main content...
```

### Avoid

- Using `.mb-4` on h1 directly — use `.page-header` wrapper instead
- Custom header wrapper classes — use `.page-header`
- Custom nav wrapper classes — use `.page-nav`
- Inconsistent padding (`.py-3` vs `.py-4`) — always use `.py-4`
- Using `.container-fluid` when content constrains itself with columns anyway

### Avoid

- Inline `style.` blocks in templates (extract to CSS files)
- Generic class names that could collide (`.sidebar`, `.section`, `.title`, `.card`)
- Deep nesting beyond Block > Element (no `.a__b__c`)
- Modifiers without the base class
- Writing custom CSS that targets Bootstrap classes directly (e.g., `.card-footer { ... }`). Use Bootstrap classes as-is, but when custom styling is needed, add a BEM-namespaced class alongside (e.g., `.proposal-actions`) and target that instead.

## Design Tokens (CSS Custom Properties)

Use these instead of hardcoded colors:

### Position Colors
- `--pos-qb-bg`, `--pos-qb-text`
- `--pos-rb-bg`, `--pos-rb-text`
- `--pos-wr-bg`, `--pos-wr-text`
- `--pos-te-bg`, `--pos-te-text`
- `--pos-idp-bg`, `--pos-idp-text` (also used for DL, LB, DB)
- `--pos-k-bg`, `--pos-k-text`

### Asset Type Colors
- `--asset-player` (green)
- `--asset-pick` (blue)
- `--asset-cash` (gold)
- `--asset-rfa` (purple)
- `--asset-nothing` (gray)

### Status Colors
- `--status-{status}-bg`, `--status-{status}-text`
- Statuses: hypothetical, pending, accepted, rejected, canceled, expired, executed

### UI Colors
- `--color-link`, `--color-link-hover` — primary link/accent color (#4a90d9)
- `--color-success`, `--color-danger`, `--color-warning`, `--color-info`
- `--border-light`, `--border-muted`
- `--text-muted`, `--text-secondary`, `--text-tertiary`

## Component Library

Visit `/components` to see a live showcase of all mixins and design tokens.

## Route Conventions

### Trade-Related Routes

| Feature | Route | Model/Service |
|---------|-------|---------------|
| Trade Machine | `/trade-machine` | `services/proposals.js` |
| Proposals (in-flight) | `/proposals/:slug` | `Proposal` model |
| Trade History | `/trades` | `Transaction` model (executed trades) |
| Single Trade | `/trades/:id` | `Transaction` model |

**Key distinction**: A "proposal" is a trade in negotiation. A "trade" (or "transaction") is an executed, permanent record.

## Data Notes

### Regime Lookups

Franchises have owners that change over time. The `Regime` model tracks ownership via a `tenures` array:

```javascript
{
  displayName: "Patrick",
  tenures: [
    { franchiseId: ObjectId("..."), startSeason: 2008, endSeason: 2011 },
    { franchiseId: ObjectId("..."), startSeason: 2014, endSeason: null }
  ]
}
```

**To find who owned a franchise in a given season:**
```javascript
function getHistoricalRegime(regimes, franchiseId, season) {
  var regime = regimes.find(function(r) {
    return r.tenures && r.tenures.some(function(t) {
      return t.franchiseId.toString() === franchiseId.toString() &&
        t.startSeason <= season &&
        (t.endSeason === null || t.endSeason >= season);
    });
  });
  return regime ? regime.displayName : null;
}
```

**Common pitfalls:**
- Don't assume `regime.franchiseId` exists at the top level — it's inside `tenures[]`
- Don't assume `startYear`/`endYear` — the fields are `startSeason`/`endSeason`
- Owner names in historical data (cuts sheet, snapshots) may use 2025 regime names regardless of the actual year

### Trade Facts Structure

WordPress trade posts list what each party **receives**. In `trade-facts.js`:
- `trade.parties[i].players` = players that party i **receives**
- `trade.parties[i].cash` = cash that party i **receives**

In a 2-party trade, if party A receives player X, then party B gave player X.

### Player Name Resolution

When matching player names from external sources (trades, cuts, snapshots) to the database, always use the player resolver (`data/utils/player-resolver.js`):

```javascript
var resolver = require('../utils/player-resolver');

// Normalize names to strip suffixes (Jr., III, II, V, etc.)
var normalized = resolver.normalizePlayerName('Odell Beckham Jr.'); // -> 'odell beckham'

// Build lookup maps using normalized names
var playerByName = {};
players.forEach(function(p) {
  playerByName[resolver.normalizePlayerName(p.name)] = p;
});

// Look up using normalized input
var dbPlayer = playerByName[resolver.normalizePlayerName(tradeName)];
```

For ambiguous matches or missing players, the resolver supports interactive disambiguation with `player-resolutions.json`.

**Never match player names with raw `.toLowerCase()` comparisons** — external sources use inconsistent naming (suffixes, nicknames, typos).

### Inferred Transaction Timestamps

When seeding historical data, transactions fall into two categories:

1. **Known timestamps** — From WordPress posts, Sleeper API, etc. Use the actual timestamp.
2. **Inferred transactions** — Cuts, FA pickups, RFA conversions deduced from snapshots.

**Inferred transactions always use :33 seconds** as a conventional marker. This makes them easily identifiable in the database.

When multiple inferred transactions need ordering (e.g., drops before pickups), advance to the next minute but keep :33 seconds:
- Drops: `2008-10-02T16:00:33Z`
- Pickups: `2008-10-02T16:01:33Z`

Never use :34, :35, etc. — always :33, and increment the minute for ordering.

### Game Types
The `Game` model has a `type` field with these values:
- `regular` — Regular season games (weeks 1-15)
- `semifinal` — Playoff semifinal games
- `championship` — Championship game
- `thirdPlace` — Third place game
- `consolation` — **Ignore this.** Legacy data that exists but has no intention of ever being used. Do not display or query for consolation games.

## Patterns

### Money Formatting
Always use `formatMoney()` — never manually prepend `$`:
```pug
//- Good
| #{formatMoney(player.salary)}
| #{formatMoney(delta, { sign: 'auto' })}

//- Bad
| $#{player.salary}
```

### Position Badges
Use the mixin instead of inline styling:
```pug
//- Good
+positionBadge(player.positions)

//- Bad
span.badge(style='background: #D7EBFF; color: #1a5276')= player.positions.join('/')
```

### Contract Display
Use the helper for consistent formatting:
```pug
//- Good
| #{formatContractYears(player.startYear, player.endYear)}

//- Bad
| #{player.startYear % 100}/#{player.endYear % 100}
```

### Card Footer Links
For cards/widgets that link to a detailed view, use `.card-footer-link`:
```pug
a.card-footer-link(href='/calendar')
  span View Full Calendar
  i.fa.fa-chevron-right
```
This creates a full-width clickable footer with hover state. Used on the homepage for calendar widget and franchise cards.
