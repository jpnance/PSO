Spreadsheet Migration
=====================

Quick Start
-----------
To reset and reseed all migration data from scratch:

   runt reset-migration

Or preview what will happen without making changes:

   runt reset-migration-dry-run

The script performs preflight checks (SEASON env var, API keys, network
connectivity, Docker containers) before proceeding.


What Gets Reset
---------------
The following collections are DROPPED and reseeded:
   franchises, people, regimes, players, contracts, budgets, picks,
   transactions, leagueconfigs, rosters

The following collections are PRESERVED (pre-existing data):
   games, championships, playoffAppearances, regularSeasonWinningPercentage,
   regularSeasonWins, weeklyScoringTitles


Player Resolution
-----------------
Several steps use data/scripts/player-resolutions.json to map player names
to Sleeper IDs (or mark them as historical players). This file is tracked in
git and contains cached resolutions from previous runs. Interactive prompts
only appear for names not already resolved.

If you need to rebuild the resolutions file from scratch:
   docker compose run --rm web node data/scripts/extractPlayerResolutions.js

After running the migration, commit any changes to player-resolutions.json
so future runs don't re-prompt for the same players.


Manual Steps (for reference)
----------------------------
The resetMigration.sh script runs these steps in order:

  Step -1: Drop migration collections
  Step  0: Fetch Sleeper data (skipped if < 7 days old)
  Step  1: seedLeagueConfig.js
  Step  2: seedEntities.js (franchises, people, regimes)
  Step  3: syncPlayers.js
  Step  4: seedContracts.js (interactive)
  Step  5: seedPicks.js
  Step  6: seedDraftSelections.js (interactive, needs network)
  Step  7: seedTrades.js (interactive, needs network)
  Step  8: seedCuts.js (interactive, needs network)
  Step  9: seedBudgets.js
  Step 10: applyFixups.js

Note: seedDraftSelections.js must run before seedTrades.js so the rookie
contract heuristic can access draft data. seedTrades.js applies heuristics
to infer contract years and marks ambiguous contracts with the `ambiguous`
flag. The trade display template shows a tooltip for ambiguous player contracts.

Note: Trade cash edits now automatically trigger budget recalculation, so
fixups can safely run last.

See the script itself for full details on each step.


Manual Fixups
-------------
The applyFixups.js script reads fixups.json and calls admin route handlers with
fake request/response objects. This uses the same code paths as the admin UI.

To apply fixups independently (after reset-migration or anytime):

   runt apply-fixups
   runt apply-fixups --dry-run

Edit data/scripts/fixups.json to add/modify corrections:

   franchiseTransfer:     Transfer ownership to new owner
   seasonRollover:        Advance season with draft order + date overrides
   tradeAmendments:       Add notes/timestamps to trades
   tradeCashCorrections:  Fix or remove cash entries on trades
   playerCorrections:     Fix positions/notes on historical players

Example fixups.json:

   {
     "franchiseTransfer": {
       "sleeperRosterId": 2,
       "newOwnerName": "Nam Nguyen",
       "newDisplayName": "Nam",
       "effectiveSeason": 2026
     },
     "seasonRollover": {
       "draftOrder": { "2": 1, "9": 2, ... },
       "dateOverrides": { "nflDraft": "2026-04-23" }
     },
     "tradeCashCorrections": [
       { "tradeId": 688, "party": 0, "cash": 0, "remove": true },
       { "tradeId": 600, "party": 1, "cash": 0, "season": 2026 }
     ]
   }

To find party/cash indices for a trade, query mongo:

   docker exec pso-mongo mongosh pso --quiet --eval "
     db.transactions.findOne({type:'trade', tradeId: 600}).parties
   "

The output shows parties[0], parties[1], etc. Each party has franchiseId and
receives.cash[]. Use "party": 0 for the first party, "cash": 0 for the first
cash entry in that party's receives.cash array.


Future Work
-----------
- Transaction approval workflow: Add `pending` flag to transactions. Trades and
  cuts can be proposed (pending: true) and require commissioner approval before
  changes are applied. Commissioner screen shows all pending transactions,
  grouped by facilitatedTradeId when a cut is part of a trade. Approve triggers
  the actual Contract/Budget updates; reject discards or marks rejected.

- 2012 Expansion Draft: The league expanded from 10 to 12 franchises in 2012.
  Quinn and Mitch joined via an expansion draft where they selected existing
  players under contract and RFA rights. This data exists in the "Past Drafts"
  spreadsheet ("2012 Expansion" tab) but isn't imported by seedPicks.js since
  it's not a standard rookie draft. Consider preserving as static history.

- Historical spreadsheet snapshots: Google Sheets revision history could be
  downloaded via Drive API and parsed to reconstruct historical state at
  specific points in time. Complex and may not be worth the effort.

- Known data issues (handled in applyFixups.js):
  - #34, #36, #37: Conditional draft picks with notes explaining the conditions
    and outcomes.
  - #331: Historical exception â€” pick traded before Pick document existed.
  - #600, #688: Cash entered into wrong year in spreadsheet. Corrections applied.

- Historical contract cleanup: Trades before #361 have contract start/end years
  inferred by seedTrades.js using heuristics (date-based inference, high-salary
  auction detection). Ambiguous contracts are marked with the `ambiguous` flag
  and the template displays a callout. Use tradeContractCorrections in fixups.json
  to manually correct specific cases when you have definitive knowledge.

- Backfill pickId on trade transactions: The tradePickSchema currently stores
  denormalized pick metadata (round, season, fromFranchiseId) instead of a
  pickId reference. For trades where the corresponding Pick document exists,
  we could backfill the pickId. This would simplify ownership tracking and
  make processTrade automatically update Pick.currentFranchiseId.