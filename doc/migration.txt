Spreadsheet Migration
=====================

Quick Start
-----------
To reset and reseed all migration data from scratch:

   runt reset-migration

Or preview what will happen without making changes:

   runt reset-migration-dry-run

The script performs preflight checks (SEASON env var, API keys, network
connectivity, Docker containers) before proceeding.


What Gets Reset
---------------
The following collections are DROPPED and reseeded:
   franchises, people, regimes, players, contracts, budgets, picks,
   transactions, leagueconfigs, rosters

The following collections are PRESERVED (pre-existing data):
   games, championships, playoffAppearances, regularSeasonWinningPercentage,
   regularSeasonWins, weeklyScoringTitles


Player Resolution
-----------------
Several steps use data/scripts/player-resolutions.json to map player names
to Sleeper IDs (or mark them as historical players). This file is tracked in
git and contains cached resolutions from previous runs. Interactive prompts
only appear for names not already resolved.

If you need to rebuild the resolutions file from scratch:
   docker compose run --rm web node data/scripts/extractPlayerResolutions.js

After running the migration, commit any changes to player-resolutions.json
so future runs don't re-prompt for the same players.


Manual Steps (for reference)
----------------------------
The resetMigration.sh script runs these steps in order:

  Step -1: Drop migration collections
  Step  0: Fetch Sleeper data (skipped if < 7 days old)
  Step  1: seedLeagueConfig.js
  Step  2: seedEntities.js (franchises, people, regimes)
  Step  3: syncPlayers.js
  Step  4: seedContracts.js (interactive)
  Step  5: seedPicks.js
  Step  6: seedTrades.js (interactive, needs network)
  Step  7: seedDraftSelections.js (interactive, needs network)
  Step  8: seedCuts.js (interactive, needs network)
  Step  9: addLegacyTradeNotes.js (needs network)
  Step 10: seedBudgets.js

Note: Budgets are seeded LAST because they are calculated from contract data,
cash transactions from trades, and buy-outs from cuts. The script derives all
values from the canonical data in the database.

See the script itself for full details on each step.


Future Work
-----------
- Transaction approval workflow: Add `pending` flag to transactions. Trades and
  cuts can be proposed (pending: true) and require commissioner approval before
  changes are applied. Commissioner screen shows all pending transactions,
  grouped by facilitatedTradeId when a cut is part of a trade. Approve triggers
  the actual Contract/Budget updates; reject discards or marks rejected.

- 2012 Expansion Draft: The league expanded from 10 to 12 franchises in 2012.
  Quinn and Mitch joined via an expansion draft where they selected existing
  players under contract and RFA rights. This data exists in the "Past Drafts"
  spreadsheet ("2012 Expansion" tab) but isn't imported by seedPicks.js since
  it's not a standard rookie draft. Consider preserving as static history.

- Historical spreadsheet snapshots: Google Sheets revision history could be
  downloaded via Drive API and parsed to reconstruct historical state at
  specific points in time. Complex and may not be worth the effort.

- Trade notes to add (via /admin/trades/:id):
  - #34, #36: Conditional draft picks. Add notes explaining conditions/outcomes.
  - #331: Historical exception â€” pick traded before Pick document existed.
  - #600, #688: Cash entered into wrong year in spreadsheet. Correct the season
    and add notes explaining the discrepancy.

- Historical contract cleanup: Trades before #361 now have contract start/end
  years inferred by addLegacyTradeNotes.js where possible, with notes added for
  remaining ambiguous cases. It's possible that more resolutions are possible,
  especially if we're willing to make some simple assumptions.

- Backfill pickId on trade transactions: The tradePickSchema currently stores
  denormalized pick metadata (round, season, fromFranchiseId) instead of a
  pickId reference. For trades where the corresponding Pick document exists,
  we could backfill the pickId. This would simplify ownership tracking and
  make processTrade automatically update Pick.currentFranchiseId.