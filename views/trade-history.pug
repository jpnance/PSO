extends layout

block styles
	style.
		.trade-card {
			border: 1px solid #ddd;
			border-radius: 8px;
			margin-bottom: 1rem;
			padding: 1rem;
			background: #fafafa;
		}
		.trade-header {
			font-weight: bold;
			font-size: 1.1rem;
			border-bottom: 1px solid #eee;
			padding-bottom: 0.5rem;
			margin-bottom: 0.75rem;
		}
		.trade-date {
			color: #666;
			font-weight: normal;
			font-size: 0.9rem;
		}
		.party {
			margin-bottom: 0.75rem;
		}
		.party-name {
			font-weight: 600;
		}
		.asset-list {
			margin: 0.25rem 0 0 1.5rem;
			padding: 0;
			list-style: disc;
		}
		.asset-list li {
			margin-bottom: 0.15rem;
		}
		.asset-list li:last-child {
			margin-bottom: 0;
		}
		.asset-note {
			font-size: 0.75rem;
			color: #888;
			font-style: italic;
		}
		.trade-notes {
			font-style: italic;
			color: #666;
			font-size: 0.85rem;
			margin-top: 0.5rem;
		}
		.ambiguous-icon {
			margin-left: 0.35rem;
			color: #999;
			cursor: help;
		}
		.ambiguous-icon:hover {
			color: #666;
		}
		
		/* Filter and pagination styles */
		.filter-bar {
			background: #fff;
			border: 1px solid #ddd;
			border-radius: 8px;
			padding: 1rem;
			margin-bottom: 1.5rem;
		}
		.filter-bar select {
			font-size: 0.9rem;
		}
		.filter-summary {
			font-size: 0.9rem;
			color: #666;
		}
		.filter-summary .active-filter {
			background: #e7f1ff;
			border: 1px solid #b6d4fe;
			border-radius: 4px;
			padding: 0.2rem 0.5rem;
			margin-left: 0.5rem;
		}
		.filter-summary .active-filter .remove-filter {
			color: #6c757d;
			text-decoration: none;
			margin-left: 0.3rem;
		}
		.filter-summary .active-filter .remove-filter:hover {
			color: #dc3545;
		}
		.pagination-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-wrap: wrap;
			gap: 1rem;
			margin-bottom: 1rem;
		}
		.pagination-info {
			font-size: 0.9rem;
			color: #666;
		}
		.pagination-controls {
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}
		.pagination-controls .btn {
			padding: 0.25rem 0.5rem;
			font-size: 0.85rem;
		}
		.trade-nav {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}
		.trade-nav-link {
			display: inline-flex;
			align-items: center;
			gap: 0.3rem;
			padding: 0.4rem 0.8rem;
			border: 1px solid #ddd;
			border-radius: 6px;
			text-decoration: none;
			color: #495057;
			font-size: 0.9rem;
			transition: all 0.15s;
		}
		.trade-nav-link:hover {
			background: #f8f9fa;
			border-color: #adb5bd;
			text-decoration: none;
			color: #212529;
		}
		.trade-nav-link.disabled {
			opacity: 0.4;
			pointer-events: none;
		}
		.involved-links {
			margin-top: 0.5rem;
			font-size: 0.85rem;
		}
		.involved-links a {
			color: #6c757d;
		}
		.involved-links a:hover {
			color: #495057;
		}

block content
	div.container.py-4
		if singleTrade
			p.mb-2
				a(href="/trades") ← All Trades
			h1.mb-3 Trade ##{tradeNumber}
		else
			h1.mb-4 Trade History
			
			//- Filter bar
			div.filter-bar
				form.row.align-items-end(method="get" action="/trades")
					div.col-md-5.col-lg-4.mb-2.mb-md-0
						label.form-label.small.mb-1(for="franchise-filter") Involving
						select#franchise-filter.form-control.form-control-sm(name="franchise")
							option(value="") All franchises
							each regime in regimes
								option(value=regime.franchiseId.toString() selected=(filterFranchise === regime.franchiseId.toString()))= regime.displayName
					
					div.col-md-5.col-lg-4.mb-2.mb-md-0
						label.form-label.small.mb-1(for="partner-filter") Trading with
						select#partner-filter.form-control.form-control-sm(name="partner")
							option(value="") Anyone
							each regime in regimes
								option(value=regime.franchiseId.toString() selected=(filterPartner === regime.franchiseId.toString()))= regime.displayName
					
					
					div.col-md-2.col-lg-4.mt-2.mt-md-0
						button.btn.btn-primary.btn-sm.btn-block(type="submit")
							i.fa.fa-filter.mr-1
							| Filter
			
			if filterFranchise || filterPartner
				div.filter-summary.mt-2
					| Showing 
					if filterFranchise && filterPartner
						span.active-filter
							= filterFranchiseName
							a.remove-filter(href="/trades") ×
						|  and 
						span.active-filter
							= filterPartnerName
							a.remove-filter(href="/trades?franchise=" + filterFranchise) ×
						| 's franchises 
						span.text-muted (includes past owners)
					else if filterFranchise
						span.active-filter
							= filterFranchiseName
							a.remove-filter(href="/trades") ×
						| 's franchise 
						span.text-muted (includes past owners)
					else if filterPartner
						span.active-filter
							= filterPartnerName
							a.remove-filter(href="/trades") ×
						| 's franchise 
						span.text-muted (includes past owners)
			
			//- Pagination bar
			if totalFiltered > 0
				div.pagination-bar
					div.pagination-info
						if filterFranchise || filterPartner
							| Showing #{((page - 1) * (perPage || totalFiltered)) + 1}–#{Math.min(page * (perPage || totalFiltered), totalFiltered)} of #{totalFiltered} trades
							|  (#{totalTrades} total)
						else
							| Showing #{((page - 1) * (perPage || totalFiltered)) + 1}–#{Math.min(page * (perPage || totalFiltered), totalFiltered)} of #{totalTrades} trades
					
					if perPage && totalPages > 1
						div.pagination-controls
							if page > 1
								a.btn.btn-outline-secondary(href="/trades" + buildQuery(1, perPage)) « First
								a.btn.btn-outline-secondary(href="/trades" + buildQuery(page - 1, perPage)) ‹ Prev
							else
								span.btn.btn-outline-secondary.disabled « First
								span.btn.btn-outline-secondary.disabled ‹ Prev
							
							span.px-2 Page #{page} of #{totalPages}
							
							if page < totalPages
								a.btn.btn-outline-secondary(href="/trades" + buildQuery(page + 1, perPage)) Next ›
								a.btn.btn-outline-secondary(href="/trades" + buildQuery(totalPages, perPage)) Last »
							else
								span.btn.btn-outline-secondary.disabled Next ›
								span.btn.btn-outline-secondary.disabled Last »

		if trades.length === 0
			div.text-center.py-5
				i.fa.fa-exchange.fa-3x.text-muted.mb-3
				p.text-muted No trades found matching your filters.
		
		each trade in trades
			div.trade-card(id="trade-" + trade.number)
				div.trade-header
					if singleTrade
						| Trade ##{trade.number}
					else
						a(href="/trades/" + trade.number style="color: inherit; text-decoration: none;") Trade ##{trade.number}
					span.trade-date.ml-3 #{trade.timestamp.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
				
				each party in trade.parties
					div.party
						span.party-name #{party.franchiseName}
						if party.usePlural
							|  receive:
						else
							|  receives:
						ul.asset-list
							each asset in party.assets
								li
									div
										| #{asset.display}
										if asset.ambiguous
											span.ambiguous-icon(title="Contract years couldn't be definitively determined" data-toggle="tooltip")
												i.fa.fa-question-circle
									if asset.notes && asset.notes.length > 0
										each note in asset.notes
											if note.type === 'chain'
												div.asset-note
													each item, idx in note.items
														if idx > 0
															if item.type === 'outcome'
																|  → 
															else
																|  #{note.separator} 
														if item.type === 'outcome'
															| #{item.text}
														else if item.isCurrent
															strong ##{item.tradeNumber}
														else
															a(href="/trades/" + item.tradeNumber) ##{item.tradeNumber}
											else if note.type === 'outcome'
												div.asset-note → #{note.text}
				
				if trade.notes
					div.trade-notes #{trade.notes}
		
		//- Bottom pagination (when not in single trade view)
		if !singleTrade && perPage && totalPages > 1
			div.pagination-bar.mt-4.pt-3.border-top
				div.pagination-info
					| Page #{page} of #{totalPages}
				
				div.pagination-controls
					if page > 1
						a.btn.btn-outline-secondary(href="/trades" + buildQuery(1, perPage)) « First
						a.btn.btn-outline-secondary(href="/trades" + buildQuery(page - 1, perPage)) ‹ Prev
					else
						span.btn.btn-outline-secondary.disabled « First
						span.btn.btn-outline-secondary.disabled ‹ Prev
					
					span.px-2 Page #{page} of #{totalPages}
					
					if page < totalPages
						a.btn.btn-outline-secondary(href="/trades" + buildQuery(page + 1, perPage)) Next ›
						a.btn.btn-outline-secondary(href="/trades" + buildQuery(totalPages, perPage)) Last »
					else
						span.btn.btn-outline-secondary.disabled Next ›
						span.btn.btn-outline-secondary.disabled Last »
		//- Bottom navigation for single trade view
		if singleTrade
			div.trade-nav.mt-4.pt-3.border-top
				if prevTradeId
					a.trade-nav-link(href="/trades/" + prevTradeId)
						i.fa.fa-chevron-left
						|  Trade ##{prevTradeId}
				else
					span.trade-nav-link.disabled
						i.fa.fa-chevron-left
						|  Older
				
				if nextTradeId
					a.trade-nav-link(href="/trades/" + nextTradeId)
						| Trade ##{nextTradeId} 
						i.fa.fa-chevron-right
				else
					span.trade-nav-link.disabled
						| Newer 
						i.fa.fa-chevron-right
