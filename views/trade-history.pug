extends layout
include mixins

block title
	if singleTrade
		+title('Trade #' + tradeNumber, 'Trade History')
	else
		+title('Trade History')

block og_meta
	if singleTrade && trades.length > 0
		- var trade = trades[0]
		- var ogTitle = 'Trade #' + tradeNumber + ': ' + tradeOgTitle(trade.parties, { status: 'executed', auctionSeason: trade.auctionSeason, tradeYear: trade.tradeYear })
		meta(property='og:title' content=ogTitle)
		meta(property='og:description' content=tradeOgPlainEnglish(trade.parties, { auctionSeason: trade.auctionSeason, tradeYear: trade.tradeYear, status: 'executed' }))
		meta(property='og:image' content='https://thedynastyleague.com/images/handshake.jpg')
		meta(property='og:url' content='https://thedynastyleague.com/trades/' + tradeNumber)
	else
		meta(property='og:title' content='Trade History — Primetime Soap Operas')
		meta(property='og:description' content='Extra since ’08')
		meta(property='og:image' content='https://thedynastyleague.com/images/handshake.jpg')

block styles
	link(rel='stylesheet' href='/css/positions.css')
	link(rel='stylesheet' href='/css/components.css')
	link(rel='stylesheet' href='/css/trade-history.css')

block content
	div.container.py-4
		if singleTrade
			h1.mb-4: a.trade-history__title-link(href="/trades/" + tradeNumber) Trade ##{tradeNumber}
			
			div.row
				div.col-md-7.col-xl-5
					each trade in trades
						div.trade-card.trade-card--single(id="trade-" + trade.number)
							div.trade-card__timestamp.trade-card__timestamp--inline
								a.trade-card__date(href="/trades/" + trade.number)= formatDateLong(trade.timestamp)
								a.trade-card__time(href="/trades/" + trade.number)= formatTime(trade.timestamp)
							
							each party in trade.parties
								+tradeParty(party)
							
							if trade.notes
								div.trade-notes #{trade.notes}
					
					//- Bottom navigation
					div.trade-nav--simple.mt-4
						if prevTradeId
							a(href="/trades/" + prevTradeId) ← Trade ##{prevTradeId}
						span.flex-grow-1
						if nextTradeId
							a(href="/trades/" + nextTradeId) Trade ##{nextTradeId} →
		else
			//- Trade list view with pill filters
			- function toggle(id, ids) { return ids.includes(id) ? ids.filter(x => x !== id) : ids.concat(id); }
			//- Build query string preserving all selections
			- function buildQuery(people, regimes, franchises, showPastPeople, showPastRegimes) { var parts = []; if (people.length) parts.push('people=' + people.join(',')); if (regimes.length) parts.push('regimes=' + regimes.join(',')); if (franchises.length) parts.push('franchises=' + franchises.join(',')); if (showPastPeople) parts.push('showPastPeople=1'); if (showPastRegimes) parts.push('showPastRegimes=1'); return parts.length ? '?' + parts.join('&') : ''; }
			- var hasAnyFilter = filterPeople.length > 0 || filterRegimes.length > 0 || filterFranchises.length > 0
			- var baseQuery = buildQuery(filterPeople, filterRegimes, filterFranchises, showPastPeople, showPastRegimes)
				
				h1.mb-4 Trade History
				
				div.row
					//- SIDEBAR (appears second in DOM, but first visually on lg+)
					div#filter-sidebar.col-lg-4.order-lg-2.mb-lg-0
						//- Mobile: collapsible toggle
						div.d-lg-none.mb-3
							button.btn.btn-outline-secondary.btn-sm.w-100(type="button" data-toggle="collapse" data-target="#pills-filters")
								i.fa.fa-filter.mr-1
								if hasAnyFilter
									| Filters (#{filterPeople.length + filterRegimes.length + filterFranchises.length} active)
								else
									| Filters
						
						//- Filters container (collapsible on mobile, always visible on lg+)
						div#pills-filters.collapse.d-lg-block
							div.trade-filter.trade-filter--sticky
								//- FRANCHISES (most familiar, top)
								div.trade-filter__section
									div.trade-filter__title Franchises
									div.trade-list__pills
										each franchise in franchises
											- var fId = franchise._id.toString()
											- var isActive = filterFranchises.includes(fId)
											- var newFranchises = toggle(fId, filterFranchises)
											- var franchiseLabel = franchise.rosterId + ' · ' + franchise.displayName
											- var pillClass = isActive ? 'trade-pill trade-pill--active' : 'trade-pill'
											a(class=pillClass href="/trades" + buildQuery(filterPeople, filterRegimes, newFranchises, showPastPeople, showPastRegimes))= franchiseLabel
								
								//- REGIMES
								div.trade-filter__section
									div.trade-filter__title Regimes
									div.trade-list__pills
										each regime in currentRegimes
											- var rId = regime._id.toString()
											- var isActive = filterRegimes.includes(rId)
											- var newRegimes = toggle(rId, filterRegimes)
											- var pillClass = isActive ? 'trade-pill trade-pill--active' : 'trade-pill'
											a(class=pillClass href="/trades" + buildQuery(filterPeople, newRegimes, filterFranchises, showPastPeople, showPastRegimes))= regime.displayName
										if pastRegimes.length > 0 && !showPastRegimes
											a.trade-pill.trade-pill--toggle(href="/trades" + buildQuery(filterPeople, filterRegimes, filterFranchises, showPastPeople, true)) More…
									if pastRegimes.length > 0 && showPastRegimes
										hr.trade-list__divider
										div.trade-list__pills
											each regime in pastRegimes
												- var rId = regime._id.toString()
												- var isActive = filterRegimes.includes(rId)
												- var newRegimes = toggle(rId, filterRegimes)
												- var pillClass = isActive ? 'trade-pill trade-pill--active' : 'trade-pill'
												a(class=pillClass href="/trades" + buildQuery(filterPeople, newRegimes, filterFranchises, showPastPeople, showPastRegimes))= regime.displayName
											a.trade-pill.trade-pill--toggle(href="/trades" + buildQuery(filterPeople, filterRegimes, filterFranchises, showPastPeople, false)) Less
								
								//- PEOPLE
								div.trade-filter__section
									div.trade-filter__title People
									div.trade-list__pills
										each person in currentPeople
											- var pId = person._id.toString()
											- var isActive = filterPeople.includes(pId)
											- var newPeople = toggle(pId, filterPeople)
											- var pillClass = isActive ? 'trade-pill trade-pill--active' : 'trade-pill'
											a(class=pillClass href="/trades" + buildQuery(newPeople, filterRegimes, filterFranchises, showPastPeople, showPastRegimes))= person.name
										if pastPeople.length > 0 && !showPastPeople
											a.trade-pill.trade-pill--toggle(href="/trades" + buildQuery(filterPeople, filterRegimes, filterFranchises, true, showPastRegimes)) More…
									if pastPeople.length > 0 && showPastPeople
										hr.trade-list__divider
										div.trade-list__pills
											each person in pastPeople
												- var pId = person._id.toString()
												- var isActive = filterPeople.includes(pId)
												- var newPeople = toggle(pId, filterPeople)
												- var pillClass = isActive ? 'trade-pill trade-pill--active' : 'trade-pill'
												a(class=pillClass href="/trades" + buildQuery(newPeople, filterRegimes, filterFranchises, showPastPeople, showPastRegimes))= person.name
											a.trade-pill.trade-pill--toggle(href="/trades" + buildQuery(filterPeople, filterRegimes, filterFranchises, false, showPastRegimes)) Less
								
								//- SUMMARY & CLEAR
								div.trade-filter__section
									div.text-muted #{totalFiltered} trades
									if hasAnyFilter
										a.small(href="/trades?style=pills") Clear all filters
					
					//- MAIN CONTENT (narrower trade cards)
					div.col-lg-8.col-xl-6.order-lg-1
						div#trade-list
							if trades.length === 0
								div.text-center.py-5
									i.fa.fa-exchange.fa-3x.text-muted.mb-3
									p.text-muted No trades found matching your filters.
							
							each trade in trades
								div.trade-card.trade-card--single(id="trade-" + trade.number)
									div.trade-card__timestamp.trade-card__timestamp--inline
										a.trade-card__date(href="/trades/" + trade.number)= formatDateLong(trade.timestamp)
										a.trade-card__time(href="/trades/" + trade.number)= formatTime(trade.timestamp)
									
									div.trade-card__trade-num.mb-2
										a.trade-history__title-link(href="/trades/" + trade.number) Trade ##{trade.number}
									
									each party in trade.parties
										+tradeParty(party)
									
									if trade.notes
										div.trade-notes #{trade.notes}
						
						//- Bottom pagination
						- var pageSep = baseQuery ? '&' : '?'
						div#pagination.trade-nav--simple.mt-4
							if olderPage
								a(href="/trades" + baseQuery + (olderPage > 1 ? pageSep + "page=" + olderPage : "")) ← Older
							span.flex-grow-1
							if newerPage
								a(href="/trades" + baseQuery + pageSep + "page=" + newerPage) Newer →
							else if !isDefaultView
								a(href="/trades" + baseQuery) Newest →

block scripts
	script(src='/js/trade-history.js')
