extends layout
include mixins

block title
	if singleTrade
		+title('Trade #' + tradeNumber, 'Trade History')
	else
		+title('Trade History')

block og_meta
	if singleTrade && trades.length > 0
		- var trade = trades[0]
		- var ogTitle = 'Trade #' + tradeNumber + ': ' + tradeOgTitle(trade.parties, { status: 'executed', auctionSeason: trade.auctionSeason, tradeYear: trade.tradeYear })
		meta(property='og:title' content=ogTitle)
		meta(property='og:description' content=tradeOgPlainEnglish(trade.parties, { auctionSeason: trade.auctionSeason, tradeYear: trade.tradeYear, status: 'executed' }))
		meta(property='og:image' content='https://thedynastyleague.com/images/handshake.jpg')
		meta(property='og:url' content='https://thedynastyleague.com/trades/' + tradeNumber)
	else
		meta(property='og:title' content='Trade History — Primetime Soap Operas')
		meta(property='og:description' content='Extra since ’08')
		meta(property='og:image' content='https://thedynastyleague.com/images/handshake.jpg')

block styles
	link(rel='stylesheet' href='/css/positions.css')
	link(rel='stylesheet' href='/css/components.css')
	link(rel='stylesheet' href='/css/trade-history.css')

block content
	div.container.py-4
		if singleTrade
			h1.mb-4 Trade ##{tradeNumber}
			
			div.row
				div.col-md-7.col-xl-5
					each trade in trades
						div.trade-card.trade-card--single(id="trade-" + trade.number)
							div.trade-card__timestamp.trade-card__timestamp--inline
								span.trade-card__date= formatDateLong(trade.timestamp)
								span.trade-card__time= formatTime(trade.timestamp)
							
							each party in trade.parties
								+tradeParty(party)
							
							if trade.notes
								div.trade-notes #{trade.notes}
					
					//- Bottom navigation
					div.trade-nav--simple.mt-4
						if prevTradeId
							a(href="/trades/" + prevTradeId) ← Trade ##{prevTradeId}
						span.flex-grow-1
						if nextTradeId
							a(href="/trades/" + nextTradeId) Trade ##{nextTradeId} →
		else
			h1.mb-4 Trade History
			
			div.row
				//- Filter panel
				div.col-lg-3.order-lg-2.mb-4.mb-lg-0
					div.trade-filter.trade-filter--sticky
						//- Go to trade
						div.trade-filter__section
							div.trade-filter__title Jump to Trade
							form.input-group.input-group-sm(onsubmit="window.location.href='/trades/' + this.q.value; return false;")
								input.form-control(type="text" name="q" placeholder="#" pattern="[0-9]+" title="Enter a trade number")
								div.input-group-append
									button.btn.btn-outline-secondary(type="submit") Go
						
						//- Filters
						div.trade-filter__section
							div.trade-filter__title Filter
							form(method="get" action="/trades")
								div.form-group.mb-2
									label.small.mb-1(for="franchise-filter") Franchise
									select#franchise-filter.form-control.form-control-sm(name="franchise")
										option(value="") All
										each regime in regimes
											option(value=regime.franchiseId.toString() selected=(filterFranchise === regime.franchiseId.toString()))= regime.displayName
								
								div.form-group.mb-2
									label.small.mb-1(for="partner-filter") Trading with
									select#partner-filter.form-control.form-control-sm(name="partner")
										option(value="") Anyone
										each regime in regimes
											option(value=regime.franchiseId.toString() selected=(filterPartner === regime.franchiseId.toString()))= regime.displayName
								
								button.btn.btn-primary.btn-sm.btn-block(type="submit")
									i.fa.fa-filter.mr-1
									| Apply
							
							if filterFranchise || filterPartner
								div.filter-summary
									| Showing: 
									if filterFranchise
										span.active-filter
											= filterFranchiseName
											a.remove-filter(href=filterPartner ? "/trades?partner=" + filterPartner : "/trades") ×
									if filterPartner
										if filterFranchise
											|  + 
										span.active-filter
											= filterPartnerName
											a.remove-filter(href=filterFranchise ? "/trades?franchise=" + filterFranchise : "/trades") ×
									div.text-muted.small.mt-1 (includes past owners)
						
						//- Pagination
						if totalFiltered > 0
							div.trade-filter__section
								div.trade-filter__title Browse
								div.pagination-info
									if filterFranchise || filterPartner
										| #{totalFiltered} of #{totalTrades} trades
									else
										| #{totalTrades} trades
									if perPage
										br
										if isDefaultView
											| Newest
										else
											| Page #{page} of #{totalPages}
								
								if perPage && totalPages > 1
									div.trade-filter__nav
										div.trade-filter__nav-left
											if olderPage
												a.trade-nav-link(href="/trades" + buildQuery(1, perPage)) «
												a.trade-nav-link(href="/trades" + buildQuery(olderPage, perPage)) ‹
											else
												span.trade-nav-link.invisible «
												span.trade-nav-link.invisible ‹
										div.trade-filter__nav-right
											if newerPage
												a.trade-nav-link(href="/trades" + buildQuery(newerPage, perPage)) ›
												a.trade-nav-link(href="/trades") »
											else if !isDefaultView
												span.trade-nav-link.invisible ›
												a.trade-nav-link(href="/trades") »
											else
												span.trade-nav-link.invisible ›
												span.trade-nav-link.invisible »
				
				//- Main content
				div.col-lg-9.order-lg-1
					//- Top pagination
					if perPage && totalPages > 1
						div.pagination-nav.mb-3
							div.pagination-left
								if olderPage
									a.trade-nav-link(href="/trades" + buildQuery(1, perPage)) « Oldest
									a.trade-nav-link(href="/trades" + buildQuery(olderPage, perPage)) ‹ Older
								else
									span.trade-nav-link.invisible « Oldest
									span.trade-nav-link.invisible ‹ Older
							span.flex-grow-1
							div.pagination-right
								if newerPage
									a.trade-nav-link(href="/trades" + buildQuery(newerPage, perPage)) Newer ›
									a.trade-nav-link(href="/trades") Newest »
								else if !isDefaultView
									span.trade-nav-link.invisible Newer ›
									a.trade-nav-link(href="/trades") Newest »
								else
									span.trade-nav-link.invisible Newer ›
									span.trade-nav-link.invisible Newest »
					
					if trades.length === 0
						div.text-center.py-5
							i.fa.fa-exchange.fa-3x.text-muted.mb-3
							p.text-muted No trades found matching your filters.
					
					each trade in trades
						div.trade-card(id="trade-" + trade.number)
							div.trade-header
								a(href="/trades/" + trade.number style="color: inherit; text-decoration: none;") Trade ##{trade.number}
								div.trade-date= formatDateTime(trade.timestamp)
							
							each party in trade.parties
								+tradeParty(party)
							
							if trade.notes
								div.trade-notes #{trade.notes}
					
					//- Bottom pagination
					if perPage && totalPages > 1
						div.pagination-nav.mt-4
							div.pagination-left
								if olderPage
									a.trade-nav-link(href="/trades" + buildQuery(1, perPage)) « Oldest
									a.trade-nav-link(href="/trades" + buildQuery(olderPage, perPage)) ‹ Older
								else
									span.trade-nav-link.invisible « Oldest
									span.trade-nav-link.invisible ‹ Older
							span.flex-grow-1
							div.pagination-right
								if newerPage
									a.trade-nav-link(href="/trades" + buildQuery(newerPage, perPage)) Newer ›
									a.trade-nav-link(href="/trades") Newest »
								else if !isDefaultView
									span.trade-nav-link.invisible Newer ›
									a.trade-nav-link(href="/trades") Newest »
								else
									span.trade-nav-link.invisible Newer ›
									span.trade-nav-link.invisible Newest »
