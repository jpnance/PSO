extends layout

include mixins

block title
	+title('Sleeper Import', 'Admin')

block styles
	link(rel='stylesheet' href='/css/admin-sleeper-import.css')

block content
	.container.my-4
		h1.mb-4 Sleeper Transaction Import

		if error
			.alert.alert-danger.mb-4
				strong Error: 
				= error

		//- Year selection
		.card.mb-4
			.card-header Select Year
			.card-body
				if years.length === 0
					p.text-muted No transaction files found. Add JSON files to #[code data/sleeper/transactions-YYYY.json]
				else
					form.form-inline(method='GET' action='/admin/sleeper-import')
						.form-group.mr-3
							label.mr-2(for='year') Year
							select#year.form-control(name='year')
								each y in years
									option(value=y selected=(y === selectedYear))= y
						button.btn.btn-primary(type='submit') Load Transactions

		if result
			//- Stats summary
			.row.mb-4
				.col-md-3
					.card
						.card-body.text-center
							.h2.mb-0= result.stats.total
							.text-muted Total Transactions
				.col-md-3
					.card
						.card-body.text-center
							.h2.mb-0= result.stats.withIssues
							.text-muted(class=result.stats.withIssues > 0 ? 'text-warning' : '') With Issues
				.col-md-3
					.card
						.card-body.text-center
							.h2.mb-0= result.stats.commissionerMatched
							.text-muted Commissioner → Trade
				.col-md-3
					.card
						.card-body.text-center
							.h2.mb-0= result.stats.commissionerUnmatched
							.text-muted(class=result.stats.commissionerUnmatched > 0 ? 'text-warning' : '') Unmatched Commissioner

			//- Type breakdown
			.row.mb-4
				.col-md-6
					.card
						.card-header By Type
						.card-body
							each count, type in result.stats.byType
								.d-flex.justify-content-between.mb-1
									span.badge.badge-secondary= type
									span= count
				.col-md-6
					.card
						.card-header By Season
						.card-body
							each count, season in result.stats.bySeason
								.d-flex.justify-content-between.mb-1
									span= season
									span= count

			//- Missing players warning
			if result.stats.missingPlayers.length > 0
				.alert.alert-warning.mb-4
					h5.alert-heading Missing Players (#{result.stats.missingPlayers.length})
					.missing-players-list
						each mp in result.stats.missingPlayers
							span.badge.badge-warning.mr-1.mb-1= mp

			//- Actions bar
			.d-flex.justify-content-between.align-items-center.mb-3
				div
					.btn-group.mr-3
						button.btn.btn-outline-secondary.dropdown-toggle(type='button' data-toggle='dropdown')
							| Set Unhandled...
						.dropdown-menu
							a.dropdown-item.bulk-set(href='#' data-disposition='import') Import
							a.dropdown-item.bulk-set(href='#' data-disposition='ignore') Ignore
							a.dropdown-item.bulk-set(href='#' data-disposition='unsure') Unsure
					button#saveAnnotations.btn.btn-success(disabled)
						i.fa.fa-save.mr-1
						| Save Annotations
					span#saveStatus.ml-2.text-muted
					button#generateFixups.btn.btn-outline-secondary.ml-3
						i.fa.fa-wrench.mr-1
						| Generate Fixups
				div
					span.text-muted.small
						| Cluster: transactions within 120s

			//- Fixups preview modal
			#fixupsModal.modal.fade(tabindex='-1')
				.modal-dialog.modal-lg
					.modal-content
						.modal-header
							h5.modal-title Generated Fixups
							button.close(type='button' data-dismiss='modal')
								span &times;
						.modal-body
							pre#fixupsOutput.bg-light.p-3(style='max-height: 400px; overflow: auto; font-size: 0.75rem')
						.modal-footer
							button.btn.btn-secondary(type='button' data-dismiss='modal') Close
							button#copyFixups.btn.btn-outline-primary(type='button')
								i.fa.fa-copy.mr-1
								| Copy to Clipboard
							button#saveFixupsToFile.btn.btn-primary(type='button')
								i.fa.fa-save.mr-1
								| Save to data/config/

			//- Filter tabs
			ul.nav.nav-tabs.mb-3#typeTabs(role='tablist')
				li.nav-item
					a.nav-link.active(data-toggle='tab' href='#all-tab') All
				li.nav-item
					a.nav-link(data-toggle='tab' href='#issues-tab') 
						| Issues 
						if result.stats.withIssues > 0
							span.badge.badge-warning.ml-1= result.stats.withIssues
				li.nav-item
					a.nav-link(data-toggle='tab' href='#unmatched-tab')
						| Unmatched 
						if result.stats.commissionerUnmatched > 0
							span.badge.badge-warning.ml-1= result.stats.commissionerUnmatched
				each count, type in result.stats.byType
					li.nav-item
						a.nav-link(data-toggle='tab' href='#type-' + type + '-tab')
							= type
							span.badge.badge-secondary.ml-1= count

			.tab-content
				//- All transactions
				#all-tab.tab-pane.fade.show.active
					+transactionTable(result.transactions)

				//- Issues only
				#issues-tab.tab-pane.fade
					- var issuesTxs = result.transactions.filter(tx => tx.hasIssues)
					if issuesTxs.length > 0
						+transactionTable(issuesTxs)
					else
						.text-muted.text-center.py-4 No transactions with issues

				//- Unmatched commissioner actions
				#unmatched-tab.tab-pane.fade
					- var unmatchedTxs = result.transactions.filter(tx => tx.psoType === 'commissioner' && !tx.likelyTradeExecution)
					if unmatchedTxs.length > 0
						+transactionTable(unmatchedTxs)
					else
						.text-muted.text-center.py-4 All commissioner actions matched to trades

				//- By type
				each count, type in result.stats.byType
					.tab-pane.fade(id='type-' + type + '-tab')
						- var typeTxs = result.transactions.filter(tx => tx.psoType === type)
						+transactionTable(typeTxs)

mixin transactionTable(transactions)
	.table-responsive
		table.table.table-sm.table-hover.sleeper-tx-table
			thead
				tr
					th Date
					th Type
					th Week
					th Adds
					th Drops
					th Bid
					th Notes
					th Disposition
			tbody
				each tx in transactions
					-
						var badgeClass = 'badge-secondary';
						if (tx.psoType === 'trade') badgeClass = 'badge-primary';
						else if (tx.psoType === 'fa-pickup') badgeClass = 'badge-success';
						else if (tx.psoType === 'fa-cut') badgeClass = 'badge-danger';
						else if (tx.psoType === 'fa-swap') badgeClass = 'badge-info';
						else if (tx.psoType === 'commissioner') badgeClass = tx.likelyTradeExecution ? 'badge-primary' : 'badge-warning';
					-
						var rowClasses = [];
						if (tx.hasIssues) rowClasses.push('table-warning');
						if (tx.isMultiCluster) rowClasses.push('cluster-' + (tx.clusterId % 2 === 0 ? 'even' : 'odd'));
						if (tx.clusterStart && tx.isMultiCluster) rowClasses.push('cluster-start');
					tr(class=rowClasses.join(' ') data-cluster=tx.isMultiCluster ? tx.clusterId : null)
						td.text-nowrap
							- var effectiveTime = tx.statusUpdated || tx.timestamp
							= effectiveTime.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: '2-digit' })
							br
							small.text-muted= effectiveTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
						td
							span.badge(class=badgeClass)= tx.psoType
							if tx.sleeperType !== tx.psoType
								br
								small.text-muted= tx.sleeperType
						td.text-center= tx.leg || '-'
						td
							each add in tx.adds
								.player-item
									if add.psoPlayer
										a(href='/players/' + add.psoPlayer._id)= add.psoPlayer.name
									else
										span.text-danger= add.sleeperName
										|  
										i.fa.fa-exclamation-triangle.text-warning(title='Player not found in PSO')
									if add.franchise
										small.text-muted.ml-1 → F#{add.rosterId}
						td
							each drop in tx.drops
								.player-item
									if drop.psoPlayer
										a(href='/players/' + drop.psoPlayer._id)= drop.psoPlayer.name
									else
										span.text-danger= drop.sleeperName
										|  
										i.fa.fa-exclamation-triangle.text-warning(title='Player not found in PSO')
									if drop.franchise
										small.text-muted.ml-1 ← F#{drop.rosterId}
						td.text-center
							if tx.waiverBid !== null
								| $#{tx.waiverBid}
							else
								| -
						td
							if tx.psoType === 'commissioner'
								if tx.matchedTrade
									a.badge.badge-primary(href='/trades/' + tx.matchedTrade.tradeId) Trade ##{tx.matchedTrade.tradeId}
								else
									small.text-muted (unmatched)
								|  
						if tx.hasIssues
							button.btn.btn-sm.btn-outline-warning(type='button' data-toggle='collapse' data-target='#issues-' + tx.sleeperTxId)
								i.fa.fa-exclamation-triangle
								|  #{tx.issues.length}
						td.disposition-cell
							- var currentDisposition = tx.raw._pso && tx.raw._pso.disposition ? tx.raw._pso.disposition : ''
							- var currentTradeId = tx.raw._pso && tx.raw._pso.facilitatesTradeId ? tx.raw._pso.facilitatesTradeId : ''
							.d-flex.align-items-center
								select.form-control.form-control-sm.disposition-select(data-tx-id=tx.sleeperTxId)
									option(value='' selected=(currentDisposition === '')) —
									option(value='import' selected=(currentDisposition === 'import')) Import
									option(value='ignore' selected=(currentDisposition === 'ignore')) Ignore
									option(value='trade-facilitating' selected=(currentDisposition === 'trade-facilitating')) Trade Drop
									option(value='unsure' selected=(currentDisposition === 'unsure')) Unsure
								input.form-control.form-control-sm.trade-id-input.ml-1(
									type='number'
									placeholder='#'
									data-tx-id=tx.sleeperTxId
									value=currentTradeId
									style=(currentDisposition === 'trade-facilitating' ? '' : 'display:none')
								)
					if tx.hasIssues
						tr.collapse(id='issues-' + tx.sleeperTxId)
							td(colspan='8')
								.alert.alert-warning.mb-0.py-2
									ul.mb-0
										each issue in tx.issues
											li= issue

block scripts
	if selectedYear
		script.
			(function() {
				var pendingChanges = {};
				var saveBtn = document.getElementById('saveAnnotations');
				var saveStatus = document.getElementById('saveStatus');
				
				function updateSaveState() {
					var count = Object.keys(pendingChanges).length;
					saveBtn.disabled = count === 0;
					saveStatus.textContent = count > 0 ? count + ' unsaved change(s)' : '';
				}
				
				// Track disposition changes
				document.querySelectorAll('.disposition-select').forEach(function(select) {
					select.addEventListener('change', function() {
						var txId = this.dataset.txId;
						var value = this.value;
						// Find sibling input in the same cell
						var tradeInput = this.parentElement.querySelector('.trade-id-input');
						
						// Show/hide trade ID input
						if (tradeInput) {
							tradeInput.style.display = value === 'trade-facilitating' ? '' : 'none';
							if (value !== 'trade-facilitating') {
								tradeInput.value = '';
							}
						}
						
						// Sync all instances of this transaction across tabs
						document.querySelectorAll('.disposition-select[data-tx-id="' + txId + '"]').forEach(function(other) {
							if (other !== select) {
								other.value = value;
								var otherInput = other.parentElement.querySelector('.trade-id-input');
								if (otherInput) {
									otherInput.style.display = value === 'trade-facilitating' ? '' : 'none';
									if (value !== 'trade-facilitating') otherInput.value = '';
								}
							}
						});
						
						if (!pendingChanges[txId]) pendingChanges[txId] = {};
						pendingChanges[txId].disposition = value;
						updateSaveState();
					});
				});
				
				// Track trade ID changes
				document.querySelectorAll('.trade-id-input').forEach(function(input) {
					input.addEventListener('change', function() {
						var txId = this.dataset.txId;
						var value = this.value ? parseInt(this.value, 10) : null;
						
						// Sync all instances across tabs
						document.querySelectorAll('.trade-id-input[data-tx-id="' + txId + '"]').forEach(function(other) {
							if (other !== input) other.value = value || '';
						});
						
						if (!pendingChanges[txId]) pendingChanges[txId] = {};
						pendingChanges[txId].facilitatesTradeId = value;
						updateSaveState();
					});
				});
				
				// Bulk set disposition for unhandled transactions in active tab
				document.querySelectorAll('.bulk-set').forEach(function(item) {
					item.addEventListener('click', function(e) {
						e.preventDefault();
						var disposition = this.dataset.disposition;
						
						// Find the active tab pane
						var activePane = document.querySelector('.tab-pane.active');
						if (!activePane) return;
						
						// Get all disposition selects in the active pane that are unset
						var selects = activePane.querySelectorAll('.disposition-select');
						selects.forEach(function(select) {
							// Skip if already has a disposition set
							if (select.value) return;
							
							var txId = select.dataset.txId;
							select.value = disposition;
							
							// Hide trade ID input when not trade-facilitating
							var tradeInput = select.parentElement.querySelector('.trade-id-input');
							if (tradeInput) {
								tradeInput.style.display = disposition === 'trade-facilitating' ? '' : 'none';
								if (disposition !== 'trade-facilitating') tradeInput.value = '';
							}
							
							// Sync across tabs
							document.querySelectorAll('.disposition-select[data-tx-id="' + txId + '"]').forEach(function(other) {
								if (other !== select) {
									other.value = disposition;
									var otherInput = other.parentElement.querySelector('.trade-id-input');
									if (otherInput) {
										otherInput.style.display = disposition === 'trade-facilitating' ? '' : 'none';
										if (disposition !== 'trade-facilitating') otherInput.value = '';
									}
								}
							});
							
							// Track change
							if (!pendingChanges[txId]) pendingChanges[txId] = {};
							pendingChanges[txId].disposition = disposition;
						});
						
						updateSaveState();
					});
				});
				
				// Save annotations
				saveBtn.addEventListener('click', function() {
					saveBtn.disabled = true;
					saveStatus.textContent = 'Saving...';
					
					fetch('/admin/sleeper-import/save', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							year: #{selectedYear},
							annotations: pendingChanges
						})
					})
					.then(function(res) { return res.json(); })
					.then(function(data) {
						if (data.success) {
							saveStatus.textContent = 'Saved!';
							pendingChanges = {};
							setTimeout(function() { saveStatus.textContent = ''; }, 2000);
						} else {
							saveStatus.textContent = 'Error: ' + data.error;
							saveBtn.disabled = false;
						}
					})
					.catch(function(err) {
						saveStatus.textContent = 'Error: ' + err.message;
						saveBtn.disabled = false;
					});
				});
				
				// Generate fixups
				var generateBtn = document.getElementById('generateFixups');
				var fixupsOutput = document.getElementById('fixupsOutput');
				var copyBtn = document.getElementById('copyFixups');
				
				generateBtn.addEventListener('click', function() {
					generateBtn.disabled = true;
					generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> Generating...';
					
					fetch('/admin/sleeper-import/fixups?year=' + #{selectedYear})
						.then(function(res) { return res.json(); })
						.then(function(data) {
							fixupsOutput.textContent = JSON.stringify(data.fixups, null, '\t');
							$('#fixupsModal').modal('show');
						})
						.catch(function(err) {
							alert('Error: ' + err.message);
						})
						.finally(function() {
							generateBtn.disabled = false;
							generateBtn.innerHTML = '<i class="fa fa-wrench mr-1"></i> Generate Fixups';
						});
				});
				
				copyBtn.addEventListener('click', function() {
					navigator.clipboard.writeText(fixupsOutput.textContent).then(function() {
						copyBtn.innerHTML = '<i class="fa fa-check mr-1"></i> Copied!';
						setTimeout(function() {
							copyBtn.innerHTML = '<i class="fa fa-copy mr-1"></i> Copy to Clipboard';
						}, 2000);
					});
				});
				
				// Save fixups to file
				var saveToFileBtn = document.getElementById('saveFixupsToFile');
				saveToFileBtn.addEventListener('click', function() {
					saveToFileBtn.disabled = true;
					saveToFileBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> Saving...';
					
					fetch('/admin/sleeper-import/save-fixups', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ year: #{selectedYear}, fixups: JSON.parse(fixupsOutput.textContent) })
					})
					.then(function(res) { return res.json(); })
					.then(function(data) {
						if (data.success) {
							saveToFileBtn.innerHTML = '<i class="fa fa-check mr-1"></i> Saved to ' + data.filename;
							setTimeout(function() {
								saveToFileBtn.innerHTML = '<i class="fa fa-save mr-1"></i> Save to data/config/';
								saveToFileBtn.disabled = false;
							}, 3000);
						} else {
							alert('Error: ' + data.error);
							saveToFileBtn.innerHTML = '<i class="fa fa-save mr-1"></i> Save to data/config/';
							saveToFileBtn.disabled = false;
						}
					})
					.catch(function(err) {
						alert('Error: ' + err.message);
						saveToFileBtn.innerHTML = '<i class="fa fa-save mr-1"></i> Save to data/config/';
						saveToFileBtn.disabled = false;
					});
				});
			})();
