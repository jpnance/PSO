extends layout.pug
include mixins

block title
	+title(franchise.displayName, 'Franchises')

block styles
	link(rel='stylesheet' href='/css/league.css')
	link(rel='stylesheet' href='/css/positions.css')
	link(rel='stylesheet' href='/css/components.css')
	link(rel='stylesheet' href='/css/franchise.css')

block content
	div.container.py-4
		h1.mb-1= franchise.displayName
		p.text-muted
			| Owners: #{franchise.owners.join(', ')}
		
		div.row
			div.col-lg-8
				-
					// Pre-group roster by position
					var rosterByPosition = {};
					var positionKeys = [];
					franchise.roster.forEach(function(player) {
						var key = getPositionKey(player);
						if (!rosterByPosition[key]) {
							rosterByPosition[key] = [];
							positionKeys.push(key);
						}
						rosterByPosition[key].push(player);
					});
					// Sort position keys: primary position first, then single before dual
					positionKeys.sort(function(a, b) {
						var partsA = a.split('/');
						var partsB = b.split('/');
						var primaryIdxA = POSITION_ORDER.indexOf(partsA[0]);
						var primaryIdxB = POSITION_ORDER.indexOf(partsB[0]);
						if (primaryIdxA === -1) primaryIdxA = 999;
						if (primaryIdxB === -1) primaryIdxB = 999;
						if (primaryIdxA !== primaryIdxB) return primaryIdxA - primaryIdxB;
						// Same primary - single position comes before dual
						var secondaryIdxA = partsA[1] ? POSITION_ORDER.indexOf(partsA[1]) : -1;
						var secondaryIdxB = partsB[1] ? POSITION_ORDER.indexOf(partsB[1]) : -1;
						return secondaryIdxA - secondaryIdxB;
					});
				
				div.card.mb-4#rosterCard
					div.card-header.d-flex.justify-content-between.align-items-center
						span Roster
						span.badge.badge-secondary= franchise.rosterCount + '/' + rosterLimit
					div.card-body#rosterCardBody
						div.franchise-roster-cards__toolbar.mb-3
							div.franchise-roster-cards__filters
								button.btn.btn-sm.btn-outline-secondary(type='button' data-filter='expiring') Expiring
								button.btn.btn-sm.btn-primary(type='button' data-filter=currentSeason)= currentSeason
								button.btn.btn-sm.btn-outline-secondary(type='button' data-filter=currentSeason + 1)= currentSeason + 1
								button.btn.btn-sm.btn-outline-secondary(type='button' data-filter=currentSeason + 2)= currentSeason + 2
							if isOwner && canCut
								button.btn.btn-sm.btn-outline-secondary#manageToggle
									i.fa.fa-scissors.mr-1
									span.manage-label Manage
						each posKey in positionKeys
							div.franchise-roster-cards__position-group(data-position=posKey)
								div.franchise-roster-cards__grid
									each player in rosterByPosition[posKey]
										- var posClass = 'pos-' + posKey.split('/')[0]
										- var isExpiring = Number(player.endYear) === Number(currentSeason)
										- var buyout = player.salary - player.recoverable
										div.franchise-roster-cards__card(class=posClass data-start-year=player.startYear data-end-year=player.endYear data-expiring=isExpiring ? 'true' : 'false' data-recoverable=player.recoverable data-buyout=buyout)
											div.franchise-roster-cards__content
												div.franchise-roster-cards__name= player.name
												div.franchise-roster-cards__details
													span.franchise-roster-cards__salary= formatMoney(player.salary)
													span.franchise-roster-cards__separator ·
													span.franchise-roster-cards__contract= formatContractYears(player.startYear, player.endYear)
											div.franchise-roster-cards__manage-details.text-muted
												if isOwner && canCut
													- var buyout1 = player.recoverable1 !== null ? player.salary - player.recoverable1 : null
													- var buyout2 = player.recoverable2 !== null ? player.salary - player.recoverable2 : null
													button.franchise-roster-cards__action(type='button' title='Cut player' data-player-id=player._id data-player-name=player.name data-salary=player.salary data-buyout0=buyout data-buyout1=buyout1 data-buyout2=buyout2 data-recoverable0=player.recoverable data-recoverable1=player.recoverable1 data-recoverable2=player.recoverable2 data-end-year=player.endYear)
														i.fa.fa-scissors
												span= '+' + formatMoney(player.recoverable)
													if player.recoverable1 !== null
														span  / 
														span= '+' + formatMoney(player.recoverable1)
													if player.recoverable2 !== null
														span  / 
														span= '+' + formatMoney(player.recoverable2)
											div.franchise-roster-cards__badge
												+positionBadge(player.positions)
						
						- var offseasonPhases = ['dead-period', 'early-offseason', 'pre-season']
						if offseasonPhases.includes(phase) && franchise.rfaRights && franchise.rfaRights.length > 0
							div.franchise-roster-cards__rfa-section
								div.franchise-roster-cards__grid
									each player in franchise.rfaRights
										div.franchise-roster-cards__card.franchise-roster-cards__card--rfa
											div.franchise-roster-cards__content
												div.franchise-roster-cards__name= player.name
												div.franchise-roster-cards__details
													span= formatContractYears(null, null, player.salary)
											div.franchise-roster-cards__badge
												+positionBadge(player.positions)
			
			div.col-lg-4
				div.card.mb-4
					div.card-header Budget
					- var b = franchise.budgets
					table.table.table-sm.mb-0.budget-table
						thead.table-secondary
							tr
								th
								th.text-right= currentSeason
								th.text-right= currentSeason + 1
								th.text-right= currentSeason + 2
						tbody
							tr
								td Base
								td.text-right #{formatMoney(b[0].baseAmount)}
								td.text-right #{formatMoney(b[1].baseAmount)}
								td.text-right #{formatMoney(b[2].baseAmount)}
							tr
								td Payroll
								td.text-right #{formatMoney(b[0].payroll, { sign: '-' })}
								td.text-right #{formatMoney(b[1].payroll, { sign: '-' })}
								td.text-right #{formatMoney(b[2].payroll, { sign: '-' })}
							tr
								td Buy-outs
								td.text-right #{formatMoney(b[0].buyOuts, { sign: '-' })}
								td.text-right #{formatMoney(b[1].buyOuts, { sign: '-' })}
								td.text-right #{formatMoney(b[2].buyOuts, { sign: '-' })}
							tr
								td Cash In
								td.text-right #{formatMoney(b[0].cashIn, { sign: '+' })}
								td.text-right #{formatMoney(b[1].cashIn, { sign: '+' })}
								td.text-right #{formatMoney(b[2].cashIn, { sign: '+' })}
							tr
								td Cash Out
								td.text-right #{formatMoney(b[0].cashOut, { sign: '-' })}
								td.text-right #{formatMoney(b[1].cashOut, { sign: '-' })}
								td.text-right #{formatMoney(b[2].cashOut, { sign: '-' })}
							tr.available-row
								td: strong Available
								td.text-right: strong #{formatMoney(b[0].available)}
								td.text-right: strong #{formatMoney(b[1].available)}
								td.text-right: strong #{formatMoney(b[2].available)}
							tr.recoverable-row
								td Recoverable
								td.text-right #{formatMoney(b[0].recoverable, { sign: '+' })}
								td.text-right #{formatMoney(b[1].recoverable, { sign: '+' })}
								td.text-right #{formatMoney(b[2].recoverable, { sign: '+' })}
							tr.effective-cap-row
								td Effective Cap
								td.text-right #{formatMoney(b[0].baseAmount - b[0].buyOuts - b[0].cashOut + b[0].cashIn)}
								td.text-right #{formatMoney(b[1].baseAmount - b[1].buyOuts - b[1].cashOut + b[1].cashIn)}
								td.text-right #{formatMoney(b[2].baseAmount - b[2].buyOuts - b[2].cashOut + b[2].cashIn)}
				
				div.card.mb-4
					div.card-header Draft Picks
					- var availablePicks = franchise.picks.filter(p => p.status === 'available')
					- var picksBySeason = {}
					- availablePicks.forEach(p => { if (!picksBySeason[p.season]) picksBySeason[p.season] = []; picksBySeason[p.season].push(p); })
					- var seasons = Object.keys(picksBySeason).sort()
					-
						function formatPickSlot(round, pickNumber, picksPerRound) {
							if (!pickNumber) return null;
							var slotInRound = ((pickNumber - 1) % picksPerRound) + 1;
							var slot = slotInRound < 10 ? '0' + slotInRound : '' + slotInRound;
							return '#' + round + '.' + slot;
						}
					if seasons.length
						each season in seasons
							- var seasonPicks = picksBySeason[season].slice().sort(function(a, b) { return (a.pickNumber || 999) - (b.pickNumber || 999); })
							- var picksPerRound = (parseInt(season) <= 2011) ? 10 : 12
							table.table.table-sm.mb-0.picks-table
								thead
									tr.table-secondary
										th(colspan='2')= season
								tbody
									each pick, idx in seasonPicks
										- var nextPick = seasonPicks[idx + 1]
										- var isLastInRound = nextPick && nextPick.round !== pick.round
										- var pickNumStr = formatPickSlot(pick.round, pick.pickNumber, picksPerRound)
										tr(class=isLastInRound ? 'round-separator' : '')
											td
												| #{ordinal(pick.round)} Round
												if pickNumStr
													|  (#{pickNumStr})
											td.text-right.text-muted
												if pick.originalOwner
													| from #{pick.originalOwner}
					else
						p.text-muted.mb-3.ml-3 No picks data
				
				div.card.mb-4
					div.card-header Franchise History
					if franchise.regimes && franchise.regimes.length > 0
						table.table.table-sm.mb-0.history-table
							tbody
								each regime in franchise.regimes
									tr
										td
											strong= regime.displayName
											div.text-muted.small
												| #{regime.sortedOwnerNames.join(', ')}
										td.text-right.text-muted.align-middle
											if regime.endSeason
												if regime.startSeason === regime.endSeason
													| #{regime.startSeason}
												else
													| #{regime.startSeason}–#{regime.endSeason}
											else
												| #{regime.startSeason}–present
					else
						p.text-muted.mb-3.ml-3 No history available
		
		//- Cut confirmation modal
		if isOwner && canCut
			div.modal.fade#cutModal(tabindex='-1' role='dialog')
				div.modal-dialog(role='document')
					form.modal-content(method='POST' action='/franchises/' + franchise.rosterId + '/cut')
						div.modal-header
							h5.modal-title Cut Player
							button.close(type='button' data-dismiss='modal')
								span &times;
						div.modal-body
							input(type='hidden' name='playerId' id='cutPlayerId')
							input(type='hidden' name='playerName' id='cutPlayerNameInput')
							p Are you sure you want to cut <strong id="cutPlayerName"></strong>?
							table.table.table-sm.mb-0
								thead
									tr
										th
										th.text-right= currentSeason
										th.text-right= currentSeason + 1
										th.text-right= currentSeason + 2
								tbody
									tr
										td Salary
										td.text-right#cutSalary0
										td.text-right#cutSalary1
										td.text-right#cutSalary2
									tr
										td Buyout
										td.text-right#cutBuyout0
										td.text-right#cutBuyout1
										td.text-right#cutBuyout2
									tr.table-success
										td
											strong Cap Savings
										td.text-right
											strong#cutRecoverable0
										td.text-right
											strong#cutRecoverable1
										td.text-right
											strong#cutRecoverable2
						div.modal-footer
							button.btn.btn-secondary(type='button' data-dismiss='modal') Cancel
							button.btn.btn-danger(type='submit')
								i.fa.fa-scissors.mr-1
								| Cut Player

block scripts
	script(src='/js/franchise.js')
