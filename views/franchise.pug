extends layout.pug
include mixins

block title
	+title(franchise.displayName, 'Franchises')

block styles
	link(rel='stylesheet' href='/css/league.css')
	link(rel='stylesheet' href='/css/positions.css')
	link(rel='stylesheet' href='/css/components.css')
	link(rel='stylesheet' href='/css/franchise.css')

block content
	-
		// Aggregate franchise-level stats (all regimes)
		var franchiseChampionships = seasonHistory ? seasonHistory.filter(s => s.isChampion) : [];
		var franchisePlayoffs = seasonHistory ? seasonHistory.filter(s => s.madePlayoffs) : [];
		
		// Compute regime-specific stats
		var currentRegime = franchise.regimes ? franchise.regimes[0] : null;
		var currentRegimeSeasons = [];
		var currentRegimeChampionships = [];
		var currentRegimePlayoffs = [];
		var currentRegimeWins = 0;
		var currentRegimeLosses = 0;
		
		if (currentRegime && seasonHistory) {
			currentRegimeSeasons = seasonHistory.filter(s => {
				return s.season >= currentRegime.startSeason && (currentRegime.endSeason === null || s.season <= currentRegime.endSeason);
			});
			currentRegimeChampionships = currentRegimeSeasons.filter(s => s.isChampion);
			currentRegimePlayoffs = currentRegimeSeasons.filter(s => s.madePlayoffs);
			currentRegimeWins = currentRegimeSeasons.reduce((sum, s) => sum + s.wins, 0);
			currentRegimeLosses = currentRegimeSeasons.reduce((sum, s) => sum + s.losses, 0);
		}
		
		// Build regime history with their seasons
		var regimeHistory = [];
		if (franchise.regimes && seasonHistory) {
			franchise.regimes.forEach(r => {
				var regimeSeasons = seasonHistory.filter(s => {
					return s.season >= r.startSeason && (r.endSeason === null || s.season <= r.endSeason);
				});
				var regimeChamps = regimeSeasons.filter(s => s.isChampion);
				var regimePlayoffApps = regimeSeasons.filter(s => s.madePlayoffs).length;
				var regimeWins = regimeSeasons.reduce((sum, s) => sum + s.wins, 0);
				var regimeLosses = regimeSeasons.reduce((sum, s) => sum + s.losses, 0);
				regimeHistory.push({
					displayName: r.displayName,
					owners: r.sortedOwnerNames,
					startSeason: r.startSeason,
					endSeason: r.endSeason,
					seasons: regimeSeasons,
					championships: regimeChamps,
					playoffAppearances: regimePlayoffApps,
					wins: regimeWins,
					losses: regimeLosses,
					isCurrent: r.endSeason === null
				});
			});
		}
		
		// For hero: find all championships won by PEOPLE in the current regime
		// (across all their regimes with THIS franchise)
		var currentOwnerNames = currentRegime ? currentRegime.sortedOwnerNames : [];
		var heroChampionships = [];
		var ownerFirstSeason = {}; // Track when each current owner first joined this franchise
		
		if (regimeHistory.length > 0 && currentOwnerNames.length > 0) {
			// Go through regimes oldest-first to find first appearances
			regimeHistory.slice().reverse().forEach(regime => {
				regime.owners.forEach(owner => {
					if (currentOwnerNames.includes(owner) && !ownerFirstSeason[owner]) {
						ownerFirstSeason[owner] = regime.startSeason;
					}
				});
				
				// Check if any current owner was part of this regime for championships
				var hasCurrentOwner = regime.owners.some(owner => currentOwnerNames.includes(owner));
				if (hasCurrentOwner && regime.championships.length > 0) {
					regime.championships.forEach(chip => {
						heroChampionships.push(chip);
					});
				}
			});
		}
		
		// Find the earliest year any current owner joined
		var earliestOwnerSeason = Object.values(ownerFirstSeason).length > 0 
			? Math.min(...Object.values(ownerFirstSeason)) 
			: (currentRegime ? currentRegime.startSeason : null);
		
		// Total record across all seasons where current owners were present
		var totalOwnerWins = 0;
		var totalOwnerLosses = 0;
		if (seasonHistory && earliestOwnerSeason) {
			seasonHistory.filter(s => s.season >= earliestOwnerSeason).forEach(s => {
				totalOwnerWins += s.wins;
				totalOwnerLosses += s.losses;
			});
		}

	//- ========================================
	//- FRANCHISE HERO - Three options with toggle
	//- ========================================
	//- Count total franchise championships and stats
	- var franchiseChampionships = []
	- var franchiseTotalWins = 0, franchiseTotalLosses = 0, franchisePlayoffAppearances = 0
	- if (regimeHistory) regimeHistory.forEach(r => { r.championships.forEach(c => franchiseChampionships.push(c)); franchiseTotalWins += r.wins; franchiseTotalLosses += r.losses; franchisePlayoffAppearances += r.playoffAppearances || 0; })
	//- Check if this franchise is the current/most recent champion
	- var mostRecentSeason = seasonHistory && seasonHistory.length > 0 ? seasonHistory[0] : null
	- var isCurrentChampion = mostRecentSeason && mostRecentSeason.isChampion
	- var currentRegime = regimeHistory ? regimeHistory.find(r => r.isCurrent) : null
	- var pastRegimes = regimeHistory ? regimeHistory.filter(r => !r.isCurrent) : []
	- var bannersChronological = franchiseChampionships.slice().sort((a, b) => a.season - b.season)

	//- ========================================
	//- Hero section
	//- ========================================
	-
		// Build championship data with regime names
		var championsWithRegimes = [];
		if (regimeHistory) {
			regimeHistory.forEach(function(r) {
				r.championships.forEach(function(c) {
					championsWithRegimes.push({ season: c.season, regime: r.displayName });
				});
			});
			championsWithRegimes.sort(function(a, b) { return a.season - b.season; });
		}
		// All franchise seasons chronologically with regime info
		var allSeasonsChronological = [];
		if (seasonHistory && regimeHistory) {
			seasonHistory.slice().reverse().forEach(function(s) {
				var regime = regimeHistory.find(function(r) {
					return s.season >= r.startSeason && (r.endSeason === null || s.season <= r.endSeason);
				});
				allSeasonsChronological.push({
					season: s.season,
					wins: s.wins,
					losses: s.losses,
					playoffFinish: s.playoffFinish,
					madePlayoffs: s.madePlayoffs,
					regimeName: regime ? regime.displayName : null
				});
			});
		}
	
	div.franchise-hero(class=isCurrentChampion ? 'franchise-hero--champion' : '')
		div.container
			div.franchise-hero__layout
				div.franchise-hero__identity
					h1 Franchise #{franchise.rosterId}
					if currentRegime && currentRegime.owners && currentRegime.owners.length > 0
						div.franchise-hero__owners= currentRegime.owners.join(' & ')
				
				//- Championship banners
				if championsWithRegimes.length > 0
					div.franchise-hero__banners
						each chip in championsWithRegimes
							a.franchise-hero__banner(href='/franchises/' + franchise.rosterId + '/schedule/' + chip.season)
								div.franchise-hero__banner-top
									i.fa.fa-trophy
									span= chip.season
								div.franchise-hero__banner-regime= chip.regime

	div.container.py-4
		
		div.row
			div.col-lg-8
				-
					// Pre-group roster by position
					var rosterByPosition = {};
					var positionKeys = [];
					franchise.roster.forEach(function(player) {
						var key = getPositionKey(player);
						if (!rosterByPosition[key]) {
							rosterByPosition[key] = [];
							positionKeys.push(key);
						}
						rosterByPosition[key].push(player);
					});
					// Sort position keys: primary position first, then single before dual
					positionKeys.sort(function(a, b) {
						var partsA = a.split('/');
						var partsB = b.split('/');
						var primaryIdxA = POSITION_ORDER.indexOf(partsA[0]);
						var primaryIdxB = POSITION_ORDER.indexOf(partsB[0]);
						if (primaryIdxA === -1) primaryIdxA = 999;
						if (primaryIdxB === -1) primaryIdxB = 999;
						if (primaryIdxA !== primaryIdxB) return primaryIdxA - primaryIdxB;
						// Same primary - single position comes before dual
						var secondaryIdxA = partsA[1] ? POSITION_ORDER.indexOf(partsA[1]) : -1;
						var secondaryIdxB = partsB[1] ? POSITION_ORDER.indexOf(partsB[1]) : -1;
						return secondaryIdxA - secondaryIdxB;
					});
				
				div.card.mb-4#rosterCard
					div.card-header.d-flex.justify-content-between.align-items-center
						span Roster
						span.badge.badge-secondary= franchise.rosterCount + '/' + rosterLimit
					div.card-body#rosterCardBody
						div.franchise-roster-cards__toolbar.mb-3
							div.franchise-roster-cards__filters
								button.btn.btn-sm.btn-outline-secondary(type='button' data-filter='expiring') Expiring
								button.btn.btn-sm.btn-primary(type='button' data-filter=currentSeason)= currentSeason
								button.btn.btn-sm.btn-outline-secondary(type='button' data-filter=currentSeason + 1)= currentSeason + 1
								button.btn.btn-sm.btn-outline-secondary(type='button' data-filter=currentSeason + 2)= currentSeason + 2
							if isOwner && canCut
								button.btn.btn-sm.btn-outline-secondary#manageToggle
									i.fa.fa-scissors.mr-1
									span.manage-label Manage
						each posKey in positionKeys
							div.franchise-roster-cards__position-group(data-position=posKey)
								div.franchise-roster-cards__grid
									each player in rosterByPosition[posKey]
										- var posClass = 'pos-' + posKey.split('/')[0]
										- var isExpiring = Number(player.endYear) === Number(currentSeason)
										- var buyout = player.salary - player.recoverable
										div.franchise-roster-cards__card(class=posClass data-start-year=player.startYear data-end-year=player.endYear data-expiring=isExpiring ? 'true' : 'false' data-recoverable=player.recoverable data-buyout=buyout)
											div.franchise-roster-cards__content
												div.franchise-roster-cards__name= player.name
												div.franchise-roster-cards__details
													span.franchise-roster-cards__salary= formatMoney(player.salary)
													span.franchise-roster-cards__separator ·
													span.franchise-roster-cards__contract= formatContractYears(player.startYear, player.endYear)
											div.franchise-roster-cards__manage-details.text-muted
												if isOwner && canCut
													- var buyout1 = player.recoverable1 !== null ? player.salary - player.recoverable1 : null
													- var buyout2 = player.recoverable2 !== null ? player.salary - player.recoverable2 : null
													button.franchise-roster-cards__action(type='button' title='Cut player' data-player-id=player._id data-player-name=player.name data-salary=player.salary data-buyout0=buyout data-buyout1=buyout1 data-buyout2=buyout2 data-recoverable0=player.recoverable data-recoverable1=player.recoverable1 data-recoverable2=player.recoverable2 data-end-year=player.endYear)
														i.fa.fa-scissors
												span= '+' + formatMoney(player.recoverable)
													if player.recoverable1 !== null
														span  / 
														span= '+' + formatMoney(player.recoverable1)
													if player.recoverable2 !== null
														span  / 
														span= '+' + formatMoney(player.recoverable2)
											div.franchise-roster-cards__badge
												+positionBadge(player.positions)
						
						- var offseasonPhases = ['dead-period', 'early-offseason', 'pre-season']
						if offseasonPhases.includes(phase) && franchise.rfaRights && franchise.rfaRights.length > 0
							div.franchise-roster-cards__rfa-section
								div.franchise-roster-cards__grid
									each player in franchise.rfaRights
										div.franchise-roster-cards__card.franchise-roster-cards__card--rfa
											div.franchise-roster-cards__content
												div.franchise-roster-cards__name= player.name
												div.franchise-roster-cards__details
													span= formatContractYears(null, null, player.salary)
											div.franchise-roster-cards__badge
												+positionBadge(player.positions)
			
			div.col-lg-4
				div.card.mb-4
					div.card-header Budget
					- var b = franchise.budgets
					table.table.table-sm.mb-0.budget-table
						thead.table-secondary
							tr
								th
								th.text-right= currentSeason
								th.text-right= currentSeason + 1
								th.text-right= currentSeason + 2
						tbody
							tr
								td Base
								td.text-right #{formatMoney(b[0].baseAmount)}
								td.text-right #{formatMoney(b[1].baseAmount)}
								td.text-right #{formatMoney(b[2].baseAmount)}
							tr
								td Payroll
								td.text-right #{formatMoney(b[0].payroll, { sign: '-' })}
								td.text-right #{formatMoney(b[1].payroll, { sign: '-' })}
								td.text-right #{formatMoney(b[2].payroll, { sign: '-' })}
							tr
								td Buy-outs
								td.text-right #{formatMoney(b[0].buyOuts, { sign: '-' })}
								td.text-right #{formatMoney(b[1].buyOuts, { sign: '-' })}
								td.text-right #{formatMoney(b[2].buyOuts, { sign: '-' })}
							tr
								td Cash In
								td.text-right #{formatMoney(b[0].cashIn, { sign: '+' })}
								td.text-right #{formatMoney(b[1].cashIn, { sign: '+' })}
								td.text-right #{formatMoney(b[2].cashIn, { sign: '+' })}
							tr
								td Cash Out
								td.text-right #{formatMoney(b[0].cashOut, { sign: '-' })}
								td.text-right #{formatMoney(b[1].cashOut, { sign: '-' })}
								td.text-right #{formatMoney(b[2].cashOut, { sign: '-' })}
							tr.available-row
								td: strong Available
								td.text-right: strong #{formatMoney(b[0].available)}
								td.text-right: strong #{formatMoney(b[1].available)}
								td.text-right: strong #{formatMoney(b[2].available)}
							tr.recoverable-row
								td Recoverable
								td.text-right #{formatMoney(b[0].recoverable, { sign: '+' })}
								td.text-right #{formatMoney(b[1].recoverable, { sign: '+' })}
								td.text-right #{formatMoney(b[2].recoverable, { sign: '+' })}
							tr.effective-cap-row
								td Effective Cap
								td.text-right #{formatMoney(b[0].baseAmount - b[0].buyOuts - b[0].cashOut + b[0].cashIn)}
								td.text-right #{formatMoney(b[1].baseAmount - b[1].buyOuts - b[1].cashOut + b[1].cashIn)}
								td.text-right #{formatMoney(b[2].baseAmount - b[2].buyOuts - b[2].cashOut + b[2].cashIn)}
				
				//- Draft Picks card
				- var availablePicks = franchise.picks.filter(p => p.status === 'available')
				- var picksBySeason = {}
				- availablePicks.forEach(p => { if (!picksBySeason[p.season]) picksBySeason[p.season] = []; picksBySeason[p.season].push(p); })
				- var pickSeasons = [currentSeason, currentSeason + 1, currentSeason + 2].filter(s => picksBySeason[s])
				
				div.card.mb-4
					div.card-header Draft Picks
					div.card-body
						if pickSeasons.length
							each season in pickSeasons
								- var seasonPicks = picksBySeason[season].slice().sort(function(a, b) { return (a.pickNumber || (a.round * 100)) - (b.pickNumber || (b.round * 100)); })
								- var showSlots = (season === currentSeason)
								- var earlyPicks = seasonPicks.filter(function(p) { var r = p.round || Math.ceil(p.pickNumber / 12); return r <= 3; })
								- var latePicks = seasonPicks.filter(function(p) { var r = p.round || Math.ceil(p.pickNumber / 12); return r > 3; })
								div.picks-row
									div.picks-row__season= season
									div.picks-row__picks
										if earlyPicks.length
											div.picks-group
												each pick in earlyPicks
													span.picks-pill
														if showSlots && pick.pickNumber
															= formatPickNumber(pick.pickNumber, 12)
														else
															= ordinal(pick.round)
															if pick.originalOwner
																span.picks-pill__from= ' (' + pick.originalOwner + ')'
										if latePicks.length
											div.picks-group.picks-group--late
												each pick in latePicks
													span.picks-pill
														if showSlots && pick.pickNumber
															= formatPickNumber(pick.pickNumber, 12)
														else
															= ordinal(pick.round)
															if pick.originalOwner
																span.picks-pill__from= ' (' + pick.originalOwner + ')'
						else
							p.text-muted.mb-0 No picks data
				
				//- Franchise History card
				if regimeHistory && regimeHistory.length > 0
					div.card.mb-4
						div.card-header Franchise History
						div.card-body.franchise-history
							div.franchise-history__summary
								span.franchise-history__stat= franchiseTotalWins + '-' + franchiseTotalLosses + ' all-time'
								span.franchise-history__sep ·
								span.franchise-history__stat= franchisePlayoffAppearances + ' playoffs'
								span.franchise-history__sep ·
								span.franchise-history__stat= franchiseChampionships.length + ' titles'
							- var regimesChronological = regimeHistory.slice().reverse()
							each regime in regimesChronological
								div.franchise-history__regime
									div.franchise-history__regime-left
										div.franchise-history__regime-name= regime.displayName
										div.franchise-history__regime-years
											if regime.isCurrent
												= regime.startSeason + '–present'
											else if regime.startSeason === regime.endSeason
												= regime.startSeason
											else
												= regime.startSeason + '–' + regime.endSeason
									div.franchise-history__regime-right
										div.franchise-history__regime-record
											= regime.wins + '-' + regime.losses
											if regime.championships.length > 0
												each chip in regime.championships
													i.fa.fa-trophy.franchise-history__trophy(title=chip.season)
										div.franchise-history__regime-tiles
											- var seasonsChronological = regime.seasons.slice().reverse()
											each result in seasonsChronological
												- var dotClass = ''
												- if (result.playoffFinish === 'champion') dotClass = 'franchise-history__tile--champ'
												- else if (result.playoffFinish === 'runner-up') dotClass = 'franchise-history__tile--second'
												- else if (result.playoffFinish === 'third-place') dotClass = 'franchise-history__tile--third'
												- else if (result.madePlayoffs) dotClass = 'franchise-history__tile--playoffs'
												a.franchise-history__tile(href='/franchises/' + franchise.rosterId + '/schedule/' + result.season title=result.season + ': ' + result.wins + '-' + result.losses class=dotClass)
		
		//- Cut confirmation modal
		if isOwner && canCut
			div.modal.fade#cutModal(tabindex='-1' role='dialog')
				div.modal-dialog(role='document')
					form.modal-content(method='POST' action='/franchises/' + franchise.rosterId + '/cut')
						div.modal-header
							h5.modal-title Cut Player
							button.close(type='button' data-dismiss='modal')
								span &times;
						div.modal-body
							input(type='hidden' name='playerId' id='cutPlayerId')
							input(type='hidden' name='playerName' id='cutPlayerNameInput')
							p Are you sure you want to cut <strong id="cutPlayerName"></strong>?
							table.table.table-sm.mb-0
								thead
									tr
										th
										th.text-right= currentSeason
										th.text-right= currentSeason + 1
										th.text-right= currentSeason + 2
								tbody
									tr
										td Salary
										td.text-right#cutSalary0
										td.text-right#cutSalary1
										td.text-right#cutSalary2
									tr
										td Buyout
										td.text-right#cutBuyout0
										td.text-right#cutBuyout1
										td.text-right#cutBuyout2
									tr.table-success
										td
											strong Cap Savings
										td.text-right
											strong#cutRecoverable0
										td.text-right
											strong#cutRecoverable1
										td.text-right
											strong#cutRecoverable2
						div.modal-footer
							button.btn.btn-secondary(type='button' data-dismiss='modal') Cancel
							button.btn.btn-danger(type='submit')
								i.fa.fa-scissors.mr-1
								| Cut Player

block scripts
	script(src='/js/franchise.js')
