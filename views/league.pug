extends layout.pug

block styles
	link(rel='stylesheet' href='/css/components.css')
	link(rel='stylesheet' href='/league.css')

block content
	div.container-fluid.py-4
		h1.text-center.mb-4 League Overview
		
		div.row
			//- Calendar widget
			div.col-md-6.col-lg-4.mb-4
				div.card.calendar-widget
					div.card-header
						span
							i.fa.fa-calendar.mr-2
							| Calendar
						span.calendar-widget__phase= phaseName
					div.card-body
						if upcomingEvents && upcomingEvents.length > 0
							div.calendar-widget__timeline
								each event, idx in upcomingEvents
									if idx < 4
										div.calendar-widget__event(class=(idx === 0 ? 'calendar-widget__event--next' : ''))
											div.calendar-widget__event-inner
												span.calendar-widget__event-name= event.name
												span.calendar-widget__event-when
													span.calendar-widget__event-relative= event.relativeDate
													span.calendar-widget__event-date
														= event.shortDate
														if event.tentative
															| *
						else
							p.text-muted.mb-0 No upcoming events
					a.card-footer-link(href='/calendar')
						span View Full Calendar
						i.fa.fa-chevron-right
			
			//- Standings widget
			div.col-md-6.col-lg-4.col-xl-4.mb-4
				if standings && standings.standings && standings.standings.length > 0
					div.card.standings-widget
						div.card-header
							i.fa.fa-list-ol.mr-2
							if standings.isPreviousSeason
								| #{standings.season} Final Standings
							else if standings.isFinal
								| #{standings.season} Final Standings
							else
								| #{standings.season} Standings
						div.card-body.p-0
							table.table.table-sm.standings-table.mb-0
								thead
									tr
										th.col-rank
										th.col-name
										th.col-record.text-right W-L
										th.col-stat.text-right PF
										th.col-stat.text-right PA
								tbody
									each team, idx in standings.standings
										-
											var rowClass = '';
											if (standings.isFinal || standings.isPreviousSeason) {
												if (idx === 0) rowClass = 'gold-row';
												else if (idx === 1) rowClass = 'silver-row';
												else if (idx === 2) rowClass = 'bronze-row';
											}
											var isPlayoffCutoff = idx === 3;
											var isUserTeam = userFranchiseName && team.name === userFranchiseName;
										tr(class=rowClass + (isPlayoffCutoff ? ' playoff-cutoff' : '') + (isUserTeam ? ' user-team' : ''))
											td.rank= team.rank
											td.name= team.name
											td.text-right
												| #{formatRecord(team.wins, team.losses, team.ties)}
												if team.isPlayoffTeam
													br
													span.playoff-stat #{team.playoffWins}-#{team.playoffLosses}
											td.text-right
												| #{formatPoints(team.pointsFor)}
												if team.isPlayoffTeam
													br
													span.playoff-stat #{formatPoints(team.playoffPointsFor)}
											td.text-right
												| #{formatPoints(team.pointsAgainst)}
												if team.isPlayoffTeam
													br
													span.playoff-stat #{formatPoints(team.playoffPointsAgainst)}
			
			//- Schedule widget
			if schedule && schedule.sections && schedule.sections.length > 0
				div.col-md-6.col-lg-4.col-xl-3.mb-4
					div.card.schedule-widget
						div.card-header
							i.fa.fa-football-o.mr-2
							= schedule.title
						div.card-body
							-
								// Sort games to put user's game first (for regular season / semifinals only)
								function sortGamesForUser(games, userName) {
									if (!userName || !games) return games;
									// Don't sort championship round games (they have type property)
									if (games.some(function(g) { return g.type === 'championship' || g.type === 'thirdPlace'; })) {
										return games;
									}
									return games.slice().sort(function(a, b) {
										var aHasUser = a.away.name === userName || a.home.name === userName;
										var bHasUser = b.away.name === userName || b.home.name === userName;
										if (aHasUser && !bHasUser) return -1;
										if (!aHasUser && bHasUser) return 1;
										return 0;
									});
								}
							each section, sectionIdx in schedule.sections
								if section.label
									div.section-label(class=(sectionIdx > 0 ? 'mt-3' : ''))= section.label
								if section.tbd
									div.tbd-text TBD
								else if section.games
									- var sortedGames = sortGamesForUser(section.games, userFranchiseName)
									each game in sortedGames
										if game.label
											div.game-label(class={'third-place-label': game.type === 'thirdPlace'})= game.label
										div.matchup
											div.competitor(class={winner: game.away.won, loser: game.home.won})
												span.team-name
													if game.away.seed
														span.seed ##{game.away.seed} 
													= game.away.name
													if game.away.record
														span.team-record  (#{game.away.record})
												if game.away.score != null
													span.result
														span.score= formatScore(game.away.score)
														span.chevron ‹
											div.competitor(class={winner: game.home.won, loser: game.away.won})
												span.team-name
													if game.home.seed
														span.seed ##{game.home.seed} 
													= game.home.name
													if game.home.record
														span.team-record  (#{game.home.record})
												if game.home.score != null
													span.result
														span.score= formatScore(game.home.score)
														span.chevron ‹
		
		-
			var offseasonPhases = ['dead-period', 'early-offseason', 'pre-season'];
			var isOffseason = offseasonPhases.includes(phase);
			var standingsSeason = standings ? standings.season : null;
		h5.mb-3 Franchises
		div.row
			each franchise in franchises
				div.col-md-6.col-lg-4.col-xl-3.mb-4
					div.card.h-100.franchise-card
						div.card-header.franchise-card__header
							div.franchise-card__title
								span.franchise-card__name= franchise.displayName
								if franchise.record
									span.franchise-card__record
										if isOffseason && standingsSeason
											span.franchise-card__record-season= standingsSeason + ': '
										| #{formatRecord(franchise.record.wins, franchise.record.losses, franchise.record.ties)} · #{ordinal(franchise.record.rank)}
						div.card-body.franchise-card__body
							- var pc = franchise.positionCounts || {}
							- var sc = franchise.salaryCounts || {}
							
							div.franchise-card__stat
								span.franchise-card__label Roster
								span.franchise-card__value #{franchise.rosterCount}/#{rosterLimit}
							- var unusedSpots = rosterLimit - franchise.rosterCount
							div.franchise-card__bar
								if pc.QB > 0
									div.franchise-card__pos-segment.franchise-card__pos-segment--qb(style='flex: ' + pc.QB, title='QB: ' + pc.QB)
								if pc.RB > 0
									div.franchise-card__pos-segment.franchise-card__pos-segment--rb(style='flex: ' + pc.RB, title='RB: ' + pc.RB)
								if pc.WR > 0
									div.franchise-card__pos-segment.franchise-card__pos-segment--wr(style='flex: ' + pc.WR, title='WR: ' + pc.WR)
								if pc.TE > 0
									div.franchise-card__pos-segment.franchise-card__pos-segment--te(style='flex: ' + pc.TE, title='TE: ' + pc.TE)
								if pc.IDP > 0
									div.franchise-card__pos-segment.franchise-card__pos-segment--idp(style='flex: ' + pc.IDP, title='IDP: ' + pc.IDP)
								if pc.K > 0
									div.franchise-card__pos-segment.franchise-card__pos-segment--k(style='flex: ' + pc.K, title='K: ' + pc.K)
								if unusedSpots > 0
									div.franchise-card__bar-unused(style='flex: ' + unusedSpots, title='Open: ' + unusedSpots)
							div.franchise-card__stat
								span.franchise-card__label Payroll
								span.franchise-card__value= formatMoney(franchise.payroll)
							div.franchise-card__bar
								if sc.QB > 0
									div.franchise-card__salary-segment.franchise-card__salary-segment--qb(style='flex: ' + sc.QB, title='QB: $' + sc.QB)
								if sc.RB > 0
									div.franchise-card__salary-segment.franchise-card__salary-segment--rb(style='flex: ' + sc.RB, title='RB: $' + sc.RB)
								if sc.WR > 0
									div.franchise-card__salary-segment.franchise-card__salary-segment--wr(style='flex: ' + sc.WR, title='WR: $' + sc.WR)
								if sc.TE > 0
									div.franchise-card__salary-segment.franchise-card__salary-segment--te(style='flex: ' + sc.TE, title='TE: $' + sc.TE)
								if sc.IDP > 0
									div.franchise-card__salary-segment.franchise-card__salary-segment--idp(style='flex: ' + sc.IDP, title='IDP: $' + sc.IDP)
								if sc.K > 0
									div.franchise-card__salary-segment.franchise-card__salary-segment--k(style='flex: ' + sc.K, title='K: $' + sc.K)
								if franchise.available > 0
									div.franchise-card__bar-unused(style='flex: ' + franchise.available, title='Available: $' + franchise.available)
							div.franchise-card__stat
								span.franchise-card__label Available
								span.franchise-card__value= formatMoney(franchise.available)
							if franchise.nextDraftPickCount > 0
								div.franchise-card__stat
									span.franchise-card__label #{franchise.nextDraftSeason} Draft
									span.franchise-card__value #{franchise.nextDraftPickCount} pick#{franchise.nextDraftPickCount !== 1 ? 's' : ''}
							if isOffseason && franchise.rfaCount > 0
								div.franchise-card__stat
									span.franchise-card__label RFA Rights
									span.franchise-card__value= franchise.rfaCount
						a.card-footer-link(href='/franchise/' + franchise.rosterId)
							span View Franchise
							i.fa.fa-chevron-right
