extends layout
include mixins

block title
	+title('Trade Machine')

block styles
	link(rel='stylesheet' href='/css/trade.css')
	link(rel='stylesheet' href='/css/positions.css')
	link(rel='stylesheet' href='/css/components.css')

block content
	//- Asset templates - mixin output with empty data, cloned by JS
	template#asset-player-template
		+tradeAsset({type: 'player', playerName: '', positions: [], contractInfo: ''})
	template#asset-rfa-template
		+tradeAsset({type: 'rfa', playerName: '', positions: [], contractInfo: ''})
	template#asset-pick-template
		+tradeAsset({type: 'pick', pickMain: '', pickContext: ''})
	template#asset-cash-template
		+tradeAsset({type: 'cash', cashMain: '', cashContext: ''})
	template#asset-nothing-template
		+tradeAsset({type: 'nothing', display: 'Nothing'})
	//- Position badge template - pass a placeholder position for structure
	template#position-badge-template
		+positionBadge(['POS'])
	//- Alert banner template for JS error messages
	template#alert-banner-template
		+alertBanner('danger', 'fa-exclamation-circle', '')

	div.container.py-4.trade-machine
		h1.mb-4= isProcessingMode ? 'Process Trade' : 'Trade Machine'

		div.row
			//- Franchise Selection Card
			div.col-md-4.col-xl-3.mb-4
				div.card
					div.card-header
						strong Select Parties
					div.card-body
						div.trade-machine__franchise-checkboxes
							each franchise in franchises
								div.form-check.mb-1
									input.form-check-input(type="checkbox" id="check-" + franchise._id value=franchise._id)
									label.form-check-label(for="check-" + franchise._id)= franchise.displayName
						div.mt-3
							button.reset-trade-machine.btn.btn-outline-secondary.btn-sm.btn-block
								i.fa.fa-refresh.mr-1
								| Reset

			//- Trade Builder Section
			div.col-md-7.col-xl-5
				div.card.trade-details-card.d-none
					div.card-header
						strong Trade Details
					div.card-body
						each franchise in franchises
							div.trade-machine__party.d-none(id="party-" + franchise._id)
								//- Party Header
								div.trade-machine__party-header.mb-2
									span.trade-machine__party-name
										strong= franchise.displayName
										|  receive#{isPlural(franchise.displayName) ? '' : 's'}:

								//- Assets List
								div.trade-machine__assets.mb-3
									ul.asset-list.mb-0

								//- Add Asset Controls
								div.trade-machine__add-controls
									//- Trigger button (visible when collapsed)
									button.trade-machine__add-trigger.btn.btn-outline-secondary.btn-sm(type="button")
										i.fa.fa-plus.mr-1
										| Add Assets

									//- All inputs (hidden until trigger clicked)
									div.trade-machine__add-inputs.d-none
										//- Add Player
										div.input-group.input-group-sm.mb-2
											div.input-group-prepend
												span.input-group-text.trade-machine__icon--player
													i.fa.fa-user
											select.player-list.form-control
											div.input-group-append
												button.add-player.btn.trade-machine__add-btn--player(type="button")
													i.fa.fa-plus

										//- Add Pick
										div.input-group.input-group-sm.mb-2
											div.input-group-prepend
												span.input-group-text.trade-machine__icon--pick
													i.fa.fa-ticket
											select.pick-list.form-control
											div.input-group-append
												button.add-pick.btn.trade-machine__add-btn--pick(type="button")
													i.fa.fa-plus

										//- Add Cash
										div.input-group.input-group-sm.mb-2
											div.input-group-prepend
												span.input-group-text.trade-machine__icon--cash $
											input.trade-machine__amount-input.form-control(type="number" placeholder="Cash")
											select.franchise-list.form-control
											select.season-list.form-control
												option #{parseInt(season)}
												option #{parseInt(season) + 1}
												option #{parseInt(season) + 2}
											div.input-group-append
												button.add-cash.btn.trade-machine__add-btn--cash(type="button")
													i.fa.fa-plus

										//- Collapse button
										button.trade-machine__add-done.btn.btn-link.btn-sm.text-muted(type="button")
											i.fa.fa-chevron-up

								hr.trade-machine__party-separator

					//- Submit Trade section (processing mode only)
					if isProcessingMode
						div.card-footer.submit-trade-section.d-none
							div.form-group
								input#trade-notes.form-control(type="text" placeholder="Notes (optional)")
							div.alert.alert-warning.mb-3
								i.fa.fa-gavel.mr-2
								| You are acting as 
								strong commissioner
								| . This will execute the trade immediately.
							div.trade-result.mb-3
							div.confirm-execute-section.d-none.mb-3
								label.text-muted(for="confirm-execute") Type #[strong= confirmName] to confirm:
								input#confirm-execute.form-control.text-center(type="text" placeholder=confirmName autocomplete="off")
							button.submit-trade-btn.btn.btn-primary
								i.fa.fa-check.mr-1
								| Submit Trade

				//- Share/Propose Trade section (for logged-in franchise owners)
				if isLoggedIn && userFranchiseIds && userFranchiseIds.length > 0
					div.card-footer.trade-machine__footer.d-none
							div.proposal-result.mb-3
							//- Propose button only shown if user is party AND trades enabled (handled in JS)
							if tradesEnabled
								button.propose-trade-btn.btn.btn-primary.d-none
									i.fa.fa-paper-plane.mr-1
									| Propose Trade
							button.share-trade-btn.btn.btn-outline-secondary
								i.fa.fa-share-alt.mr-1
								| Share
							div.proposal-link-section.d-none.mt-3
								div.alert.alert-success.mb-2.proposal-success-message
									i.fa.fa-check.mr-2
									span.message-text Proposal sent! Share this link:
								div.input-group
									input#proposal-link.form-control(type="text" readonly)
									div.input-group-append
										button.copy-link-btn.btn.btn-outline-secondary(type="button")
											i.fa.fa-copy

block scripts
	script.
		var currentSeason = #{season};
		var isBeforeCutDay = #{isBeforeCutDay ? 'true' : 'false'};
		var rosterLimit = #{rosterLimit};
		var confirmName = !{isProcessingMode ? JSON.stringify(confirmName) : 'null'};
		var isLoggedIn = !{isLoggedIn ? 'true' : 'false'};
		var userFranchiseIds = !{JSON.stringify(userFranchiseIds || [])};
		var initialDeal = !{initialDeal ? JSON.stringify(initialDeal) : 'null'};
		var franchiseData = {};
		!{franchises.map(function(f) { return "franchiseData['" + f._id + "'] = { rosterCount: " + f.rosterCount + ", available: " + f.available + ", recoverable: " + f.recoverable + " };"; }).join('\n\t\t')}
		
		// JSON data for Trade Machine (replaces hidden DOM selects)
		var playersByFranchise = !{JSON.stringify(teams)};
		var allPicks = !{JSON.stringify(picks)};
		var franchiseList = !{JSON.stringify(franchises.map(function(f) { return { id: f._id.toString(), name: f.displayName }; }))};
	script(src='/js/trade.js')
