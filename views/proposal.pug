extends layout
include mixins

block title
	+title('Trade Proposal')

block og_meta
	- var ogImage = proposal.status === 'hypothetical' ? '/images/handfake.jpg' : '/images/handshake.jpg'
	meta(property='og:title' content=tradeOgTitle(parties, { status: proposal.status, auctionSeason: auctionSeason, tradeYear: tradeYear }))
	meta(property='og:description' content=tradeOgPlainEnglish(parties, { auctionSeason: auctionSeason, tradeYear: tradeYear, status: proposal.status }))
	meta(property='og:image' content='https://thedynastyleague.com' + ogImage)
	meta(property='og:url' content='https://thedynastyleague.com/proposals/' + proposal.publicId)

block styles
	link(rel='stylesheet' href='/css/trade.css')
	link(rel='stylesheet' href='/css/positions.css')
	link(rel='stylesheet' href='/css/components.css')
	link(rel='stylesheet' href='/css/proposal.css')

block content
	//- Alert banner template for JS error messages
	template#alert-banner-template
		+alertBanner('danger', 'fa-exclamation-circle', '')

	div.container.py-4
		h1.mb-4 Trade Proposal

		//- Main content area
		div.row
			div.col-md-7.col-xl-5
				div.card
					div.card-header.d-flex.justify-content-between.align-items-center
						strong Trade Details
						if proposal.status === 'pending' && acceptanceWindowActive
							span.proposal-countdown.badge.badge-pill(data-remaining=acceptanceWindowRemaining)
								i.fa.fa-clock-o.mr-1
								span.countdown-time --:--
						else
							+statusBadge(proposal.status)
					//- Share link for active proposals
					if proposal.status === 'hypothetical' || proposal.status === 'pending'
						div.bg-light.p-3.border-bottom
							div.input-group.input-group-sm
								div.input-group-prepend
									span.input-group-text
										i.fa.fa-link.mr-2
										| Share
								input#share-link.form-control.bg-white(type='text' readonly)
								div.input-group-append
									button.btn.btn-outline-secondary.copy-link-btn(type='button')
										i.fa.fa-copy
					div.card-body
						//- Status banners (inside card for alignment)
						if proposal.status === 'hypothetical'
							+alertBanner('secondary', 'fa-file-text-o').mb-3
								| This hypothetical trade hasn't been officially proposed.
								if tradesEnabled
									|  Anyone involved can propose it.
								else
									|  #{tradesDisabledReason}
						if proposal.status === 'pending' && !proposal.acceptanceWindowStart
							+alertBanner('warning', 'fa-refresh', 'The acceptance window expired. Accept again to restart the clock.').mb-3
						if proposal.status === 'accepted'
							+alertBanner('success', 'fa-check-circle').mb-3
								strong All parties have accepted!
								|  This trade is now waiting for commissioner approval.
						if proposal.status === 'rejected'
							+alertBanner('danger', 'fa-times-circle').mb-3
								| This proposal was rejected.
								|  
								a(href='/trade-machine?from=' + proposal.publicId) Start over →
						if proposal.status === 'canceled'
							+alertBanner('secondary', 'fa-undo').mb-3
								| This proposal was canceled by the creator.
								|  
								a(href='/trade-machine?from=' + proposal.publicId) Start over →
						if proposal.status === 'expired'
							+alertBanner('secondary', 'fa-clock-o').mb-3
								| This proposal has expired.
								|  
								a(href='/trade-machine?from=' + proposal.publicId) Start over →
						if proposal.status === 'executed'
							+alertBanner('success', 'fa-check').mb-3
								| This trade has been executed.
								if proposal.executedTransactionId
									|  
									a(href='/trades/' + proposal.executedTransactionId) View in trade history →
						
						each party in parties
							+tradeParty(party)
						//- Budget Impact
						include partials/budget-impact-table
						//- Responses (for pending trades)
						if proposal.status === 'pending'
							div.acceptance-status.mt-4.pt-3.border-top
								div.mb-2
									strong Responses
								each party, idx in parties
									- var isLast = idx === parties.length - 1
									div.proposal-response(class=isLast ? '' : 'mb-1')
										if party.accepted
											i.fa.fa-check.text-success.proposal-response__icon
										else
											i.fa.fa-circle-o.proposal-response__icon.proposal-response__icon--waiting
										span= party.franchiseName
					//- Action buttons
					if (proposal.status === 'hypothetical' && isParty) || (proposal.status === 'pending' && (isParty || isCreator))
						div.card-footer.proposal-actions
							div.proposal-actions__result
							//- Hypothetical: Propose button
							if proposal.status === 'hypothetical'
								if tradesEnabled
									button.btn.btn-primary.formalize-btn
										i.fa.fa-paper-plane.mr-1
										| Propose This Trade
								else
									button.btn.btn-primary(disabled)
										i.fa.fa-paper-plane.mr-1
										| Propose This Trade
									span.text-muted.small.ml-2
										i.fa.fa-info-circle.mr-1
										= tradesDisabledReason || 'Trades are currently disabled'
							//- Pending: Accept/Reject/Cancel buttons
							if proposal.status === 'pending'
								if isParty && !userHasAccepted
									button.btn.btn-success.mr-2.accept-btn
										i.fa.fa-check.mr-1
										| Accept
								if isParty && !isCreator
									button.btn.btn-outline-danger.mr-2.reject-btn
										i.fa.fa-times.mr-1
										| Reject
									button.btn.btn-outline-secondary.mr-2.reject-counter-btn
										i.fa.fa-exchange.mr-1
										| Reject & Counter
								if isCreator
									button.btn.btn-outline-danger.cancel-btn
										i.fa.fa-times.mr-1
										| Cancel

block scripts
	script.
		var proposalId = '#{proposal.publicId}';
		var acceptanceWindowRemaining = !{acceptanceWindowRemaining || 'null'};
		
		// Countdown timer
		function updateCountdown() {
			var $els = $('.proposal-countdown');
			if (!$els.length || acceptanceWindowRemaining === null) return;
			
			acceptanceWindowRemaining -= 1000;
			
			if (acceptanceWindowRemaining <= 0) {
				$els.find('.countdown-time').text('Expired');
				$els.addClass('proposal-countdown--warning');
				setTimeout(function() { location.reload(); }, 2000);
				return;
			}
			
			var seconds = Math.floor(acceptanceWindowRemaining / 1000);
			var mins = Math.floor(seconds / 60);
			var secs = seconds % 60;
			$els.find('.countdown-time').text(mins + ':' + secs.toString().padStart(2, '0'));
			
			if (seconds < 60) {
				$els.addClass('proposal-countdown--warning');
			}
			
			setTimeout(updateCountdown, 1000);
		}
		
		if (acceptanceWindowRemaining !== null) {
			updateCountdown();
		}
		
		// Set share link to current URL
		$('#share-link').val(window.location.href);
		
		function showResult(html) {
			$('.proposal-actions__result').html(html);
		}
		
		function showError(errors) {
			var template = document.getElementById('alert-banner-template');
			
			// For single error, clone and modify template directly with vanilla DOM
			if (errors.length === 1 && template && template.content) {
				var clonedContent = template.content.cloneNode(true);
				var banner = clonedContent.querySelector('.alert');
				if (banner) {
					banner.classList.add('mb-0');
					var spanEl = banner.querySelector('span');
					if (spanEl) {
						spanEl.textContent = errors[0];
					}
					showResult($(banner));
					return;
				}
			}
			
			// Multiple errors or fallback: build inline
			var $container = $('<div class="alert alert-danger mb-0"></div>');
			errors.forEach(function(err, i) {
				if (i > 0) {
					$container.append('<div class="mt-2"></div>');
				}
				var $row = $('<div class="d-flex align-items-start"></div>');
				$row.append('<i class="fa fa-exclamation-circle mr-2 mt-1 flex-shrink-0"></i>');
				$row.append($('<span></span>').text(err));
				$container.append($row);
			});
			
			showResult($container);
		}
		
		function startLoading($btn) {
			$btn.prop('disabled', true);
			return function() {
				$btn.prop('disabled', false);
			};
		}
		
		// Copy share link
		$('.copy-link-btn').on('click', function() {
			var $input = $('#share-link');
			$input.select();
			document.execCommand('copy');
			
			var $btn = $(this);
			var originalHtml = $btn.html();
			$btn.html('<i class="fa fa-check"></i>');
			setTimeout(function() {
				$btn.html(originalHtml);
			}, 2000);
		});
		
		$('.formalize-btn').on('click', function() {
			var restore = startLoading($(this));
			$.post('/proposals/' + proposalId + '/propose')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					restore();
					showError((xhr.responseJSON || {}).errors || ['Unknown error']);
				});
		});
		
		$('.accept-btn').on('click', function() {
			var restore = startLoading($(this));
			$.post('/proposals/' + proposalId + '/accept')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					restore();
					showError((xhr.responseJSON || {}).errors || ['Unknown error']);
				});
		});
		
		$('.reject-btn').on('click', function() {
			if (!confirm('Are you sure you want to reject this proposal?')) return;
			var restore = startLoading($(this));
			$.post('/proposals/' + proposalId + '/reject')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					restore();
					showError((xhr.responseJSON || {}).errors || ['Unknown error']);
				});
		});
		
		$('.reject-counter-btn').on('click', function() {
			var restore = startLoading($(this));
			$.post('/proposals/' + proposalId + '/reject')
				.done(function() {
					window.location.href = '/trade-machine?from=' + proposalId;
				})
				.fail(function(xhr) {
					restore();
					showError((xhr.responseJSON || {}).errors || ['Unknown error']);
				});
		});
		
		$('.cancel-btn').on('click', function() {
			if (!confirm('Are you sure you want to cancel this proposal?')) return;
			var restore = startLoading($(this));
			$.post('/proposals/' + proposalId + '/cancel')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					restore();
					showError((xhr.responseJSON || {}).errors || ['Unknown error']);
				});
		});
		
