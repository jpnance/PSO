extends layout
include mixins

block og_meta
	- var ogImage = proposal.status === 'hypothetical' ? '/images/handfake.jpg' : '/images/handshake.jpg'
	meta(property='og:title' content=tradeOgTitle(parties, { status: proposal.status, auctionSeason: auctionSeason, tradeYear: tradeYear }))
	meta(property='og:description' content=tradeOgPlainEnglish(parties, { auctionSeason: auctionSeason, tradeYear: tradeYear }))
	meta(property='og:image' content='https://thedynastyleague.com' + ogImage)
	meta(property='og:url' content='https://thedynastyleague.com/propose/' + proposal.publicId)

block styles
	link(rel='stylesheet' href='/trade.css')
	link(rel='stylesheet' href='/css/positions.css')
	link(rel='stylesheet' href='/css/components.css')
	link(rel='stylesheet' href='/css/proposal.css')

block content
	//- Alert banner template for JS error messages
	template#alert-banner-template
		+alertBanner('danger', 'fa-exclamation-circle', '')

	div.container.py-4
		p: a(href='/propose') ← Back to Trade Machine

		//- Status header
		div.d-flex.flex-wrap.justify-content-between.align-items-center.mb-4
			h1.mb-2.mb-md-0 Trade Proposal
			+statusBadge(proposal.status)

		//- Main content area with columns
		div.row
			//- Left column: Trade details
			div.col-lg-8.mb-4.mb-lg-0
				div.card
					div.card-header
						strong Trade Details
					//- Share link for active proposals
					if proposal.status === 'hypothetical' || proposal.status === 'pending'
						div.bg-light.p-3.border-bottom
							div.input-group.input-group-sm
								div.input-group-prepend
									span.input-group-text
										i.fa.fa-link.mr-2
										| Share
								input#share-link.form-control.bg-white(type='text' readonly)
								div.input-group-append
									button.btn.btn-outline-secondary.copy-link-btn(type='button')
										i.fa.fa-copy
					div.card-body
						each party in parties
							+tradeParty(party)
						//- Budget Impact
						include partials/budget-impact-table
					//- Action buttons for drafts
					if proposal.status === 'hypothetical' && isParty
						div.card-footer
							div.action-result
							if tradesEnabled
								button.btn.btn-primary.formalize-btn
									i.fa.fa-paper-plane.mr-1
									| Propose This Trade
							else
								button.btn.btn-primary(disabled)
									i.fa.fa-paper-plane.mr-1
									| Propose This Trade
								span.text-muted.small.ml-2
									i.fa.fa-info-circle.mr-1
									= tradesDisabledReason || 'Trades are currently disabled'
			//- Right column: Status, notices
			div.col-lg-4
				//- Hypothetical trade notice
				if proposal.status === 'hypothetical'
					+alertBanner('secondary', 'fa-file-text-o').mb-4
						| This hypothetical trade hasn't been officially proposed.
						if tradesEnabled
							|  Anyone involved can propose it.
						else
							|  #{tradesDisabledReason}

				//- Acceptance window notice
				if proposal.status === 'pending' && acceptanceWindowActive
					div.alert.alert-warning.mb-4.text-center
						i.fa.fa-clock-o.mr-2
						strong Waiting for acceptance.
						|  All parties must accept within:
						div.proposal-countdown.mt-2#countdown(data-remaining=acceptanceWindowRemaining)
							| --:--

				//- Window was reset notice
				if proposal.status === 'pending' && !proposal.acceptanceWindowStart
					+alertBanner('warning', 'fa-refresh', 'The acceptance window expired. Accept again to restart the clock.').mb-4

				//- Accepted - ready for commissioner
				if proposal.status === 'accepted'
					+alertBanner('success', 'fa-check-circle').mb-4
						strong All parties have accepted!
						|  This trade is now waiting for commissioner approval.

				//- Rejected/Canceled/Expired notice
				if proposal.status === 'rejected'
					+alertBanner('danger', 'fa-times-circle', 'This proposal was rejected.').mb-4

				if proposal.status === 'canceled'
					+alertBanner('secondary', 'fa-undo', 'This proposal was canceled by the creator.').mb-4

				if proposal.status === 'expired'
					+alertBanner('secondary', 'fa-clock-o', 'This proposal has expired.').mb-4

				if proposal.status === 'countered'
					+alertBanner('info', 'fa-reply').mb-4
						| This proposal was countered with a new version.
						if proposal.counteredById
							|  
							a(href='/propose/' + proposal.counteredById) View counter-proposal →

				if proposal.status === 'executed'
					+alertBanner('success', 'fa-check').mb-4
						| This trade has been executed.
						if proposal.executedTransactionId
							|  
							a(href='/trades/' + proposal.executedTransactionId) View in trade history →

				//- Party acceptance status widget
				if proposal.status === 'pending'
					div.card.mb-4
						div.card-header
							strong Acceptance Status
						div.card-body
							each party, idx in parties
								- var isLast = idx === parties.length - 1
								div.proposal-status(class=isLast ? '' : 'mb-2')
									div.proposal-status__check(class=party.accepted ? 'proposal-status__check--accepted' : 'proposal-status__check--waiting')
										if party.accepted
											i.fa.fa-check
										else
											i.fa.fa-hourglass-half
									span.font-weight-bold= party.franchiseName
									if party.accepted
										span.text-muted.small — accepted
						//- Action buttons for pending trades
						if isParty || isCreator
							div.card-footer
								div.action-result
								if isParty && !userHasAccepted
									button.btn.btn-success.mr-2.accept-btn
										i.fa.fa-check.mr-1
										| Accept
								if isParty && !isCreator
									button.btn.btn-outline-danger.mr-2.reject-btn
										i.fa.fa-times.mr-1
										| Reject
								if isCreator
									button.btn.btn-outline-danger.cancel-btn
										i.fa.fa-times.mr-1
										| Cancel

block scripts
	script.
		var proposalId = '#{proposal.publicId}';
		var acceptanceWindowRemaining = !{acceptanceWindowRemaining || 'null'};
		
		// Countdown timer
		function updateCountdown() {
			var $el = $('#countdown');
			if (!$el.length || acceptanceWindowRemaining === null) return;
			
			acceptanceWindowRemaining -= 1000;
			
			if (acceptanceWindowRemaining <= 0) {
				$el.text('Expired').addClass('proposal-countdown--warning');
				setTimeout(function() { location.reload(); }, 2000);
				return;
			}
			
			var seconds = Math.floor(acceptanceWindowRemaining / 1000);
			var mins = Math.floor(seconds / 60);
			var secs = seconds % 60;
			$el.text(mins + ':' + secs.toString().padStart(2, '0'));
			
			if (seconds < 60) {
				$el.addClass('proposal-countdown--warning');
			}
			
			setTimeout(updateCountdown, 1000);
		}
		
		if (acceptanceWindowRemaining !== null) {
			updateCountdown();
		}
		
		// Set share link to current URL
		$('#share-link').val(window.location.href);
		
		function showResult(html) {
			$('.action-result').html(html);
		}
		
		function showError(errors) {
			var template = document.getElementById('alert-banner-template');
			var $container = $('<div class="alert alert-danger"></div>');
			
			errors.forEach(function(err, i) {
				if (i > 0) {
					$container.append('<div class="mt-2"></div>');
				}
				var $banner = $(template.content.cloneNode(true)).children();
				$container.append($banner.children());
				$container.find('span').last().text(err);
			});
			
			showResult($container);
		}
		
		function startLoading($btn) {
			$btn.prop('disabled', true);
			return function() {
				$btn.prop('disabled', false);
			};
		}
		
		// Copy share link
		$('.copy-link-btn').on('click', function() {
			var $input = $('#share-link');
			$input.select();
			document.execCommand('copy');
			
			var $btn = $(this);
			var originalHtml = $btn.html();
			$btn.html('<i class="fa fa-check"></i>');
			setTimeout(function() {
				$btn.html(originalHtml);
			}, 2000);
		});
		
		$('.formalize-btn').on('click', function() {
			var restore = startLoading($(this));
			$.post('/propose/' + proposalId + '/formalize')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					restore();
					showError((xhr.responseJSON || {}).errors || ['Unknown error']);
				});
		});
		
		$('.accept-btn').on('click', function() {
			var restore = startLoading($(this));
			$.post('/propose/' + proposalId + '/accept')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					restore();
					showError((xhr.responseJSON || {}).errors || ['Unknown error']);
				});
		});
		
		$('.reject-btn').on('click', function() {
			if (!confirm('Are you sure you want to reject this proposal?')) return;
			var restore = startLoading($(this));
			$.post('/propose/' + proposalId + '/reject')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					restore();
					showError((xhr.responseJSON || {}).errors || ['Unknown error']);
				});
		});
		
		$('.cancel-btn').on('click', function() {
			if (!confirm('Are you sure you want to cancel this proposal?')) return;
			var restore = startLoading($(this));
			$.post('/propose/' + proposalId + '/withdraw')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					restore();
					showError((xhr.responseJSON || {}).errors || ['Unknown error']);
				});
		});
		
