extends layout
include mixins

block og_meta
	- var ogImage = proposal.status === 'draft' ? '/images/handfake.jpg' : '/images/handshake.jpg'
	meta(property='og:title' content=tradeOgTitle(parties))
	meta(property='og:description' content=tradeOgDescription(parties))
	meta(property='og:image' content='https://thedynastyleague.com' + ogImage)
	meta(property='og:url' content='https://thedynastyleague.com/propose/' + proposal.publicId)

block styles
	link(rel='stylesheet' href='/trade.css')
	link(rel='stylesheet' href='/css/positions.css')
	link(rel='stylesheet' href='/css/components.css')
	style.
		/* Proposal page styles (BEM) */
		.proposal-status {
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}
		.proposal-status__check {
			width: 1.5rem;
			height: 1.5rem;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.proposal-status__check--accepted {
			background: var(--color-success);
			color: white;
		}
		.proposal-status__check--waiting {
			background: #e9ecef;
			color: #6c757d;
		}
		
		.proposal-countdown {
			font-size: 1.5rem;
			font-weight: 600;
			font-family: monospace;
		}
		.proposal-countdown--warning {
			color: #dc3545;
		}

block content
	div.container.py-4
		p: a(href='/propose') ← Back to Trade Machine

		//- Status header
		div.d-flex.justify-content-between.align-items-center.mb-4
			h1.mb-0 Trade Proposal
			+statusBadge(proposal.status, proposal.status === 'draft' ? 'hypothetical' : proposal.status)

		//- Hypothetical trade notice
		if proposal.status === 'draft'
			div.alert.alert-secondary.mb-4
				i.fa.fa-file-text-o.mr-2
				strong This is a hypothetical trade for discussion.
				if tradesEnabled
					|  Anyone involved can make it official to start the acceptance process.
				else
					|  #{tradesDisabledReason}

		//- Acceptance window notice
		if proposal.status === 'pending' && acceptanceWindowActive
			div.alert.alert-warning.mb-4.text-center
				i.fa.fa-clock-o.mr-2
				strong Waiting for acceptance.
				|  All parties must accept within:
				div.proposal-countdown.mt-2#countdown(data-remaining=acceptanceWindowRemaining)
					| --:--

		//- Window expired notice
		if proposal.status === 'pending' && !acceptanceWindowActive && proposal.acceptanceWindowStart
			div.alert.alert-info.mb-4
				i.fa.fa-refresh.mr-2
				| Acceptances were reset because the 10-minute window expired. Someone needs to accept again to restart the clock.

		//- Accepted - ready for commissioner
		if proposal.status === 'accepted'
			div.alert.alert-success.mb-4
				i.fa.fa-check-circle.mr-2
				strong All parties have accepted!
				|  This trade is now waiting for commissioner approval.

		//- Rejected/Withdrawn/Expired notice
		if proposal.status === 'rejected'
			div.alert.alert-danger.mb-4
				i.fa.fa-times-circle.mr-2
				| This proposal was rejected.

		if proposal.status === 'withdrawn'
			div.alert.alert-secondary.mb-4
				i.fa.fa-undo.mr-2
				| This proposal was withdrawn by the creator.

		if proposal.status === 'expired'
			div.alert.alert-secondary.mb-4
				i.fa.fa-clock-o.mr-2
				| This proposal has expired.

		if proposal.status === 'countered'
			div.alert.alert-info.mb-4
				i.fa.fa-reply.mr-2
				| This proposal was countered with a new version.
				if proposal.counteredById
					|  
					a(href='/propose/' + proposal.counteredById) View counter-proposal →

		if proposal.status === 'executed'
			div.alert.alert-success.mb-4
				i.fa.fa-check.mr-2
				| This trade has been executed.
				if proposal.executedTransactionId
					|  
					a(href='/trades/' + proposal.executedTransactionId) View in trade history →

		//- Share link for active proposals
		if proposal.status === 'draft' || proposal.status === 'pending'
			div.input-group.input-group-sm.mb-4
				div.input-group-prepend
					span.input-group-text.bg-primary.text-white.border-primary
						i.fa.fa-link.mr-2
						| Share
				input#share-link.form-control.bg-white(type='text' readonly)
				div.input-group-append
					button.btn.btn-outline-primary.copy-link-btn(type='button')
						i.fa.fa-copy

		//- Main content area with columns
		div.row
			//- Left column: Trade details
			div.col-lg-8.mb-4.mb-lg-0
				div.card
					div.card-header
						strong Trade Details
					div.card-body
						each party in parties
							+tradeParty(party)

			//- Right column: Status, Budget
			div.col-lg-4
				//- Party acceptance status widget
				if proposal.status === 'pending'
					div.card.mb-4
						div.card-header
							strong Acceptance Status
						div.card-body
							each party in parties
								div.proposal-status.mb-2
									div.proposal-status__check(class=party.accepted ? 'proposal-status__check--accepted' : 'proposal-status__check--waiting')
										if party.accepted
											i.fa.fa-check
										else
											i.fa.fa-hourglass-half
									span.font-weight-bold= party.franchiseName
									if party.accepted
										span.text-muted.small — accepted

				//- Budget Impact
				div.card.mb-4
					div.card-header.d-flex.justify-content-between.align-items-center
						strong Budget Impact
						if isCashNeutral
							span.badge.badge-success
								i.fa.fa-balance-scale.mr-1
								| Cash-Neutral
						else
							span.badge.badge-warning
								i.fa.fa-exclamation-triangle.mr-1
								| Not Cash-Neutral
					div.card-body
						include partials/budget-impact

		//- Action buttons
		div.action-result.mb-3

		if proposal.status === 'draft' && isParty
			if tradesEnabled
				button.btn.btn-primary.mr-2.formalize-btn
					i.fa.fa-gavel.mr-1
					| Propose This Trade
			else
				button.btn.btn-primary.mr-2(disabled)
					i.fa.fa-gavel.mr-1
					| Propose This Trade
				p.text-muted.small.mt-2
					i.fa.fa-info-circle.mr-1
					= tradesDisabledReason || 'Trades are currently disabled'

		if proposal.status === 'draft' && isCreator
			button.btn.btn-outline-danger.delete-btn
				i.fa.fa-trash.mr-1
				| Delete

		if proposal.status === 'pending' && isParty && !userHasAccepted
			button.btn.btn-success.mr-2.accept-btn
				i.fa.fa-check.mr-1
				| Accept

		if proposal.status === 'pending' && isParty && !isCreator
			button.btn.btn-outline-danger.mr-2.reject-btn
				i.fa.fa-times.mr-1
				| Reject

		if proposal.status === 'pending' && isCreator
			button.btn.btn-outline-danger.cancel-btn
				i.fa.fa-times.mr-1
				| Cancel

block scripts
	script.
		var proposalId = '#{proposal.publicId}';
		var acceptanceWindowRemaining = !{acceptanceWindowRemaining || 'null'};
		
		// Countdown timer
		function updateCountdown() {
			var $el = $('#countdown');
			if (!$el.length || acceptanceWindowRemaining === null) return;
			
			acceptanceWindowRemaining -= 1000;
			
			if (acceptanceWindowRemaining <= 0) {
				$el.text('Expired').addClass('proposal-countdown--warning');
				setTimeout(function() { location.reload(); }, 2000);
				return;
			}
			
			var seconds = Math.floor(acceptanceWindowRemaining / 1000);
			var mins = Math.floor(seconds / 60);
			var secs = seconds % 60;
			$el.text(mins + ':' + secs.toString().padStart(2, '0'));
			
			if (seconds < 60) {
				$el.addClass('proposal-countdown--warning');
			}
			
			setTimeout(updateCountdown, 1000);
		}
		
		if (acceptanceWindowRemaining !== null) {
			updateCountdown();
		}
		
		// Set share link to current URL
		$('#share-link').val(window.location.href);
		
		function showResult(html) {
			$('.action-result').html(html);
		}
		
		function showError(errors) {
			var html = '<div class="alert alert-danger">';
			errors.forEach(function(err, i) {
				if (i > 0) html += '<br>';
				html += '<i class="fa fa-exclamation-circle mr-2"></i>' + err;
			});
			html += '</div>';
			showResult(html);
		}
		
		// Copy share link
		$('.copy-link-btn').on('click', function() {
			var $input = $('#share-link');
			$input.select();
			document.execCommand('copy');
			
			var $btn = $(this);
			var originalHtml = $btn.html();
			$btn.html('<i class="fa fa-check"></i>');
			setTimeout(function() {
				$btn.html(originalHtml);
			}, 2000);
		});
		
		$('.formalize-btn').on('click', function() {
			var $btn = $(this);
			$btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin mr-1"></i> Processing...');
			
			$.post('/propose/' + proposalId + '/formalize')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					$btn.prop('disabled', false).html('<i class="fa fa-gavel mr-1"></i> Propose This Trade');
					var errors = (xhr.responseJSON || {}).errors || ['Unknown error'];
					showError(errors);
				});
		});
		
		$('.accept-btn').on('click', function() {
			var $btn = $(this);
			$btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin mr-1"></i> Accepting...');
			
			$.post('/propose/' + proposalId + '/accept')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					$btn.prop('disabled', false).html('<i class="fa fa-check mr-1"></i> Accept');
					var errors = (xhr.responseJSON || {}).errors || ['Unknown error'];
					showError(errors);
				});
		});
		
		$('.reject-btn').on('click', function() {
			if (!confirm('Are you sure you want to reject this proposal?')) return;
			
			var $btn = $(this);
			$btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin mr-1"></i> Rejecting...');
			
			$.post('/propose/' + proposalId + '/reject')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					$btn.prop('disabled', false).html('<i class="fa fa-times mr-1"></i> Reject');
					var errors = (xhr.responseJSON || {}).errors || ['Unknown error'];
					showError(errors);
				});
		});
		
		$('.cancel-btn').on('click', function() {
			if (!confirm('Are you sure you want to cancel this proposal?')) return;
			
			var $btn = $(this);
			$btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin mr-1"></i> Cancelling...');
			
			$.post('/propose/' + proposalId + '/withdraw')
				.done(function() { location.reload(); })
				.fail(function(xhr) {
					$btn.prop('disabled', false).html('<i class="fa fa-times mr-1"></i> Cancel');
					var errors = (xhr.responseJSON || {}).errors || ['Unknown error'];
					showError(errors);
				});
		});
		
		$('.delete-btn').on('click', function() {
			if (!confirm('Are you sure you want to delete this hypothetical trade?')) return;
			
			var $btn = $(this);
			$btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin mr-1"></i> Deleting...');
			
			$.post('/propose/' + proposalId + '/withdraw')
				.done(function() { window.location.href = '/propose'; })
				.fail(function(xhr) {
					$btn.prop('disabled', false).html('<i class="fa fa-trash mr-1"></i> Delete');
					var errors = (xhr.responseJSON || {}).errors || ['Unknown error'];
					showError(errors);
				});
		});
