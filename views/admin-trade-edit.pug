extends layout.pug
include mixins

block title
	+title('Edit Trade #' + (trade.tradeId || trade._id), 'Trades', 'Admin')

block styles
	link(rel='stylesheet' href='/css/positions.css')
	link(rel='stylesheet' href='/css/components.css')
	link(rel='stylesheet' href='/css/trade-history.css')
	link(rel='stylesheet' href='/css/admin-trade-edit.css')

block content
	-
		function formatDateTimeLocal(ts) {
			if (!ts) return '';
			var d = new Date(ts);
			// Convert to ET for display in the input
			var etDate = new Date(d.toLocaleString('en-US', { timeZone: 'America/New_York' }));
			var year = etDate.getFullYear();
			var month = String(etDate.getMonth() + 1).padStart(2, '0');
			var day = String(etDate.getDate()).padStart(2, '0');
			var hours = String(etDate.getHours()).padStart(2, '0');
			var mins = String(etDate.getMinutes()).padStart(2, '0');
			return year + '-' + month + '-' + day + 'T' + hours + ':' + mins;
		}
		// Check if trade has any cash to edit
		function hasCash(parties) {
			return parties.some(function(p) { return p.cash && p.cash.length > 0; });
		}
	
	div.container.py-4
		if query.saved
			div.alert.alert-success.alert-dismissible.fade.show
				strong Saved!
				|  Trade updated successfully.
				button.close(type='button' data-dismiss='alert') &times;
		
		h1.mb-4: a.trade-history__title-link(href="/trades/" + trade.tradeId) Trade ##{trade.tradeId || '(no ID)'}
		
		form(method='POST' action='/admin/trades/' + trade._id)
			div.row
				div.col-md-7.col-xl-5.mb-4
					//- Trade card display (same as trade-history)
					div.trade-card.trade-card--single
						div.trade-card__timestamp.trade-card__timestamp--inline
							span.trade-card__date= formatDateLong(trade.timestamp)
							span.trade-card__time= formatTime(trade.timestamp)
						
						each party in parties
							+tradeParty(party)
						
						if trade.notes
							div.trade-notes #{trade.notes}
				
				div.col-md-5.col-xl-4
					//- Edit form
					div.card.mb-4
						div.card-header
							strong Edit Trade
						div.card-body
							//- Cash editing (only show if there's cash)
							if hasCash(parties)
								div.mb-4
									label.font-weight-bold Cash
									each party, partyIdx in parties
										each cash, cashIdx in party.cash
											div.admin-trade-edit__cash-row.mb-2
												span.admin-trade-edit__cash-label= party.franchiseName
												span $
												input.form-control.form-control-sm(
													type='number'
													name='cash_' + partyIdx + '_' + cashIdx + '_amount'
													value=cash.amount
												)
												span in
												input.form-control.form-control-sm(
													type='number'
													name='cash_' + partyIdx + '_' + cashIdx + '_season'
													value=cash.season
												)
							
							//- Notes
							div.mb-4
								label.font-weight-bold(for='notes') Notes
								textarea.form-control(
									id='notes'
									name='notes'
									rows='3'
									placeholder='Notes about corrections, conditions, etc.'
								)= trade.notes || ''
							
							//- Timestamp
							div.mb-4
								label.font-weight-bold(for='timestamp') Timestamp (ET)
								input.form-control(
									type='datetime-local'
									id='timestamp'
									name='timestamp'
									value=formatDateTimeLocal(trade.timestamp)
								)
							
							//- Trade Info
							dl.mb-4
								dt ID
								dd: code= trade._id
								if trade.tradeId
									dt Trade Number
									dd= trade.tradeId
								dt Source
								dd= trade.source
							
							//- Actions
							div.d-flex
								button.btn.btn-primary.mr-2(type='submit') Save Changes
								a.btn.btn-secondary(href='/admin/trades') Back
