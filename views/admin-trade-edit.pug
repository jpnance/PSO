extends layout.pug

block styles
	link(rel='stylesheet' href='/league.css')
	link(rel='stylesheet' href='/css/admin-trade-edit.css')

block content
	-
		function formatDateTimeLocal(ts) {
			if (!ts) return '';
			var d = new Date(ts);
			// Convert to ET for display in the input
			var etDate = new Date(d.toLocaleString('en-US', { timeZone: 'America/New_York' }));
			var year = etDate.getFullYear();
			var month = String(etDate.getMonth() + 1).padStart(2, '0');
			var day = String(etDate.getDate()).padStart(2, '0');
			var hours = String(etDate.getHours()).padStart(2, '0');
			var mins = String(etDate.getMinutes()).padStart(2, '0');
			return year + '-' + month + '-' + day + 'T' + hours + ':' + mins;
		}
		function formatTimestampDisplay(ts) {
			if (!ts) return 'Unknown';
			var d = new Date(ts);
			var options = { 
				weekday: 'long', 
				year: 'numeric', 
				month: 'long', 
				day: 'numeric',
				hour: 'numeric',
				minute: '2-digit',
				timeZone: 'America/New_York'
			};
			return d.toLocaleString('en-US', options) + ' ET';
		}
		// Build sorted asset list like trade history page
		function buildAssetList(party, partyIdx) {
			var assets = [];
			// Players first, sorted by salary desc
			var sortedPlayers = party.players.slice().sort(function(a, b) {
				return (b.salary || 0) - (a.salary || 0);
			});
			sortedPlayers.forEach(function(p) {
				var display = p.playerName;
				if (p.salary) {
					display += ' ($' + p.salary + ', ' + formatContractYears(p.startYear, p.endYear) + ')';
				}
				if (p.rfaRights) {
					display += ' (RFA)';
				}
				assets.push({ type: 'player', display: display });
			});
			// RFA rights
			party.rfaRights.forEach(function(rfa) {
				assets.push({ type: 'player', display: rfa.playerName + ' RFA rights' });
			});
			// Group picks and cash by season
			var seasonAssets = {};
			party.picks.forEach(function(pick) {
				var season = pick.season;
				if (!seasonAssets[season]) seasonAssets[season] = [];
				seasonAssets[season].push({ 
					type: 'pick', 
					display: formatPickDisplay({ round: pick.round, pickNumber: pick.pickNumber, season: pick.season, origin: pick.fromName }),
					sortOrder: 0,
					sortKey: pick.pickNumber || 999
				});
			});
			party.cash.forEach(function(cash, cashIdx) {
				var season = cash.season;
				if (!seasonAssets[season]) seasonAssets[season] = [];
				seasonAssets[season].push({ 
					type: 'cash', 
					sortOrder: 1,
					partyIdx: partyIdx,
					cashIdx: cashIdx,
					amount: cash.amount,
					season: cash.season,
					fromName: cash.fromName
				});
			});
			// Add season assets in order
			var seasons = Object.keys(seasonAssets).map(Number).sort(function(a, b) { return a - b; });
			seasons.forEach(function(season) {
				var items = seasonAssets[season];
				items.sort(function(a, b) {
					if (a.sortOrder !== b.sortOrder) return a.sortOrder - b.sortOrder;
					return (a.sortKey || 0) - (b.sortKey || 0);
				});
				items.forEach(function(item) {
					assets.push(item);
				});
			});
			return assets;
		}
	
	div.container.py-4
		nav.mb-3
			a(href='/admin/trades') ← Back to Trades
		
		if query.saved
			div.alert.alert-success.alert-dismissible.fade.show
				strong Saved!
				|  Trade updated successfully.
				button.close(type='button' data-dismiss='alert') &times;
		
		h1.mb-2
			| Trade ##{trade.tradeId || '(no ID)'}
		p.admin-trade-edit__meta
			= formatTimestampDisplay(trade.timestamp)
			if trade.tradeId
				|  · 
				a(href='/trades/' + trade.tradeId) View Trade
		
		form(method='POST' action='/admin/trades/' + trade._id)
			div.row
				div.col-lg-8
					div.card.mb-4
						div.card-header
							strong Trade Details
						div.card-body
							each party, partyIdx in parties
								div.admin-trade-edit__party
									div.admin-trade-edit__party-name
										strong= party.franchiseName
										|  receive#{party.usePlural ? '' : 's'}:
									
									- var assets = buildAssetList(party, partyIdx)
									if assets.length
										ul.admin-trade-edit__asset-list
											each asset in assets
												if asset.type === 'cash'
													li
														div.admin-trade-edit__cash-row
															span $
															input.form-control.form-control-sm(
																type='number'
																name='cash_' + asset.partyIdx + '_' + asset.cashIdx + '_amount'
																value=asset.amount
															)
															span in
															input.form-control.form-control-sm(
																type='number'
																name='cash_' + asset.partyIdx + '_' + asset.cashIdx + '_season'
																value=asset.season
															)
															span.admin-trade-edit__cash-row-from from #{asset.fromName}
												else
													li= asset.display
									else
										p.text-muted.mb-0 (nothing)
							
							div.admin-trade-edit__notes
								label.font-weight-bold(for='notes') Notes
								textarea.form-control(
									id='notes'
									name='notes'
									rows='3'
									placeholder='Notes about corrections, conditions, etc.'
								)= trade.notes || ''
				
				div.col-lg-4
					div.card.mb-4
						div.card-header
							strong Trade Info
						div.card-body
							dl.mb-0
								dt ID
								dd: code= trade._id
								if trade.tradeId
									dt Trade ID
									dd= trade.tradeId
								dt Source
								dd= trade.source
								dt Timestamp (ET)
								dd
									input.form-control.form-control-sm(
										type='datetime-local'
										name='timestamp'
										value=formatDateTimeLocal(trade.timestamp)
									)
					
					div.d-flex.mt-3
						button.btn.btn-primary.mr-2(type='submit') Save Changes
						a.btn.btn-secondary(href='/admin/trades') Cancel
