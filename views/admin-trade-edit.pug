extends layout.pug

block styles
	link(rel='stylesheet' href='/league.css')
	style.
		.party-section {
			padding: 1rem 0;
			border-bottom: 1px solid #dee2e6;
		}
		.party-section:first-child {
			padding-top: 0;
		}
		.notes-section {
			padding-top: 1rem;
		}
		.party-name {
			margin-bottom: 0.5rem;
		}
		.asset-list {
			margin-bottom: 0;
			padding-left: 1.25rem;
		}
		.asset-list li {
			padding: 0.25rem 0;
		}
		.cash-edit-row {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}
		.cash-edit-row input {
			width: 80px;
		}
		.cash-edit-row .from-label {
			font-size: 0.85rem;
			color: #6c757d;
		}
		.trade-meta {
			font-size: 0.9rem;
			color: #6c757d;
		}
		.timestamp-edit {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}
		.timestamp-edit input {
			width: auto;
		}

block content
	-
		function formatRound(round) {
			if (round === 1) return '1st';
			if (round === 2) return '2nd';
			if (round === 3) return '3rd';
			return round + 'th';
		}
		function formatDateTimeLocal(ts) {
			if (!ts) return '';
			var d = new Date(ts);
			// Convert to ET for display in the input
			var etDate = new Date(d.toLocaleString('en-US', { timeZone: 'America/New_York' }));
			var year = etDate.getFullYear();
			var month = String(etDate.getMonth() + 1).padStart(2, '0');
			var day = String(etDate.getDate()).padStart(2, '0');
			var hours = String(etDate.getHours()).padStart(2, '0');
			var mins = String(etDate.getMinutes()).padStart(2, '0');
			return year + '-' + month + '-' + day + 'T' + hours + ':' + mins;
		}
		function formatTimestampDisplay(ts) {
			if (!ts) return 'Unknown';
			var d = new Date(ts);
			var options = { 
				weekday: 'long', 
				year: 'numeric', 
				month: 'long', 
				day: 'numeric',
				hour: 'numeric',
				minute: '2-digit',
				timeZone: 'America/New_York'
			};
			return d.toLocaleString('en-US', options) + ' ET';
		}
		// Build sorted asset list like trade history page
		function buildAssetList(party, partyIdx) {
			var assets = [];
			// Players first, sorted by salary desc
			var sortedPlayers = party.players.slice().sort(function(a, b) {
				return (b.salary || 0) - (a.salary || 0);
			});
			sortedPlayers.forEach(function(p) {
				var display = p.playerName;
				if (p.salary) {
					var startYr = p.startYear ? String(p.startYear % 100).padStart(2, '0') : 'FA';
					var endYr = p.endYear ? String(p.endYear % 100).padStart(2, '0') : '?';
					display += ' ($' + p.salary + ', ' + startYr + '/' + endYr + ')';
				}
				if (p.rfaRights) {
					display += ' (RFA)';
				}
				assets.push({ type: 'player', display: display });
			});
			// RFA rights
			party.rfaRights.forEach(function(rfa) {
				assets.push({ type: 'player', display: rfa.playerName + ' (RFA rights)' });
			});
			// Group picks and cash by season
			var seasonAssets = {};
			party.picks.forEach(function(pick) {
				var season = pick.season;
				if (!seasonAssets[season]) seasonAssets[season] = [];
				seasonAssets[season].push({ 
					type: 'pick', 
					display: formatRound(pick.round) + ' round from ' + pick.fromName + ' in ' + pick.season,
					sortOrder: 0,
					sortKey: pick.pickNumber || 999
				});
			});
			party.cash.forEach(function(cash, cashIdx) {
				var season = cash.season;
				if (!seasonAssets[season]) seasonAssets[season] = [];
				seasonAssets[season].push({ 
					type: 'cash', 
					sortOrder: 1,
					partyIdx: partyIdx,
					cashIdx: cashIdx,
					amount: cash.amount,
					season: cash.season,
					fromName: cash.fromName
				});
			});
			// Add season assets in order
			var seasons = Object.keys(seasonAssets).map(Number).sort(function(a, b) { return a - b; });
			seasons.forEach(function(season) {
				var items = seasonAssets[season];
				items.sort(function(a, b) {
					if (a.sortOrder !== b.sortOrder) return a.sortOrder - b.sortOrder;
					return (a.sortKey || 0) - (b.sortKey || 0);
				});
				items.forEach(function(item) {
					assets.push(item);
				});
			});
			return assets;
		}
	
	div.container.py-4
		nav.mb-3
			a(href='/admin/trades') ← Back to Trades
		
		if query.saved
			div.alert.alert-success.alert-dismissible.fade.show
				strong Saved!
				|  Trade updated successfully.
				button.close(type='button' data-dismiss='alert') &times;
		
		h1.mb-2
			| Trade ##{trade.wordpressTradeId || '(no ID)'}
		p.trade-meta
			= formatTimestampDisplay(trade.timestamp)
			if trade.wordpressTradeId
				|  · 
				a(href='https://thedynastyleague.wordpress.com/trade-' + trade.wordpressTradeId + '/' target='_blank') View on WordPress
		
		form(method='POST' action='/admin/trades/' + trade._id)
			div.row
				div.col-lg-8
					div.card.mb-4
						div.card-header
							strong Trade Details
						div.card-body
							each party, partyIdx in parties
								div.party-section
									div.party-name
										strong= party.franchiseName
										|  receives:
									
									- var assets = buildAssetList(party, partyIdx)
									if assets.length
										ul.asset-list
											each asset in assets
												if asset.type === 'cash'
													li
														div.cash-edit-row
															span $
															input.form-control.form-control-sm(
																type='number'
																name='cash_' + asset.partyIdx + '_' + asset.cashIdx + '_amount'
																value=asset.amount
															)
															span in
															input.form-control.form-control-sm(
																type='number'
																name='cash_' + asset.partyIdx + '_' + asset.cashIdx + '_season'
																value=asset.season
															)
															span.from-label from #{asset.fromName}
												else
													li= asset.display
									else
										p.text-muted.mb-0 (nothing)
							
							div.notes-section
								label.font-weight-bold(for='notes') Notes
								textarea.form-control(
									id='notes'
									name='notes'
									rows='3'
									placeholder='Notes about corrections, conditions, etc.'
								)= trade.notes || ''
								small.form-text.text-muted
									| Corrections, conditional pick outcomes, or other clarifications.
				
				div.col-lg-4
					div.card.mb-4
						div.card-header
							strong Trade Info
						div.card-body
							dl.mb-0
								dt ID
								dd: code= trade._id
								if trade.wordpressTradeId
									dt WordPress ID
									dd= trade.wordpressTradeId
								dt Source
								dd= trade.source
								dt Timestamp (ET)
								dd
									input.form-control.form-control-sm(
										type='datetime-local'
										name='timestamp'
										value=formatDateTimeLocal(trade.timestamp)
									)
					
					div.d-flex.mt-3
						button.btn.btn-primary.mr-2(type='submit') Save Changes
						a.btn.btn-secondary(href='/admin/trades') Cancel
