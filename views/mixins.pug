//- Shared Pug mixins for PSO views

//- Title breadcrumbs
//- Usage: +title('Page Name') → "Page Name « Primetime Soap Operas"
//- Usage: +title('Sub Page', 'Section') → "Sub Page « Section « Primetime Soap Operas"
mixin title(...breadcrumbs)
	title
		each breadcrumb in breadcrumbs
			| #{breadcrumb} &laquo;
			|
		| Primetime Soap Operas

//- Display a win-loss-tie record
mixin record(record)
	| #{record.wins}-#{record.losses}
	if record.ties
		| -#{record.ties}

//- Position badge with color styling
//- Usage: +positionBadge(player.positions) or +positionBadge(['QB'])
mixin positionBadge(positions)
	if positions && positions.length
		- var sorted = sortedPositions(positions)
		span.position-badge(class='pos-' + sorted[0])= sorted.join('/')

//- Status badge for trade proposals and other statuses
//- Usage: +statusBadge('pending') or +statusBadge(proposal.status)
mixin statusBadge(status, displayText)
	span.status-badge(class='status-' + status)= displayText || status

//- Alert banner with icon as bullet point
//- Usage: +alertBanner('warning', 'fa-refresh', 'Simple message')
//- Or with block: +alertBanner('success', 'fa-check') followed by indented content
mixin alertBanner(type, icon, text)
	div.alert(class='alert-' + type).d-flex.align-items-start
		i.fa(class=icon).mr-2.mt-1.flex-shrink-0
		span
			if text
				| #{text}
			else
				block

//- Season navigation with quick buttons and optional older/dropdown
//- Usage: +seasonNav(season, quickSeasons, olderSeasons, 'Past Drafts', '?season=')
mixin seasonNav(currentSeason, quickSeasons, olderSeasons, olderLabel, queryPrefix)
	- var prefix = queryPrefix || '?season='
	div.season-nav
		if olderSeasons && olderSeasons.length > 0
			- var isOlderSeason = olderSeasons.indexOf(currentSeason) !== -1
			select.older-select(class=(isOlderSeason ? 'active' : '') onchange='if(this.value) window.location.href="' + prefix + '"+this.value')
				option(value='' selected=!isOlderSeason)= olderLabel || 'Older'
				each s in olderSeasons
					option(value=s selected=(s === currentSeason))= s
		each s in quickSeasons
			a.btn.btn-sm(href=prefix + s class=(s === currentSeason ? 'btn-primary' : 'btn-outline-secondary'))= s

//- Trade asset icon based on type
//- Usage: +tradeAssetIcon(asset.type)
mixin tradeAssetIcon(type)
	span.asset-icon(class="icon-" + type)
		if type === 'player'
			i.fa.fa-user
		else if type === 'pick'
			i.fa.fa-ticket
		else if type === 'cash'
			i.fa.fa-dollar
		else if type === 'rfa'
			i.fa.fa-file-text-o
		else
			i.fa.fa-times

//- Trade asset content (player, pick, cash, etc.)
//- Usage: +tradeAssetContent(asset)
mixin tradeAssetContent(asset)
	span.asset-content(class="icon-" + asset.type)
		span.asset-details
			if (asset.type === 'player' || asset.type === 'rfa') && asset.hasOwnProperty('playerName')
				span.asset-name
					| #{asset.playerName}
					if asset.positions && asset.positions.length > 0
						|  
						+positionBadge(asset.positions)
				span.asset-meta
					| #{asset.contractInfo}
					if asset.ambiguous
						span.ambiguous-icon(title="Contract years couldn't be definitively determined" data-toggle="tooltip")
							i.fa.fa-question-circle
			else if asset.type === 'pick' && asset.hasOwnProperty('pickMain')
				span.asset-text
					strong #{asset.pickMain}
					|  #{asset.pickContext}
			else if asset.type === 'cash' && asset.hasOwnProperty('cashMain')
				span.asset-text
					strong #{asset.cashMain}
					|  #{asset.cashContext}
			else
				span.asset-text
					strong #{asset.display}
					if asset.ambiguous
						span.ambiguous-icon(title="Contract years couldn't be definitively determined" data-toggle="tooltip")
							i.fa.fa-question-circle
		if asset.notes && asset.notes.length > 0
			each note in asset.notes
				if note.type === 'chain'
					span.asset-note
						each item, idx in note.items
							if idx > 0
								if item.type === 'outcome'
									|  → 
								else
									|  #{note.separator} 
							if item.type === 'outcome'
								| #{item.text}
							else if item.isCurrent
								strong ##{item.tradeNumber}
							else
								a(href="/trades/" + item.tradeNumber) ##{item.tradeNumber}
				else if note.type === 'outcome'
					span.asset-note → #{note.text}

//- Single trade asset list item
//- Usage: +tradeAsset(asset)
mixin tradeAsset(asset)
	li
		+tradeAssetIcon(asset.type)
		+tradeAssetContent(asset)

//- Full trade party with assets
//- Usage: +tradeParty(party)
mixin tradeParty(party)
	div.party
		span.party-name #{party.franchiseName}
		if party.usePlural
			|  receive:
		else
			|  receives:
		ul.asset-list
			if party.assets && party.assets.length > 0
				each asset in party.assets
					+tradeAsset(asset)
			else
				li
					span.asset-icon.icon-nothing
						i.fa.fa-times
					span.asset-content.icon-nothing
						span.asset-text Nothing

//- Budget impact table for trades
//- Usage: +budgetImpactTable(budgetImpact)
//- budgetImpact: [{ franchiseName, seasons: [{ season, delta }] }]
mixin budgetImpactTable(budgetImpact)
	table.table.table-sm.table-borderless.mb-0
		thead
			tr
				th
				each s in budgetImpact[0].seasons
					th.text-right= s.season
		tbody
			each impact in budgetImpact
				tr
					td: strong= impact.franchiseName
					each s in impact.seasons
						td.text-right(class=deltaClass(s.delta))= formatMoney(s.delta, { sign: 'auto' })

//- Standings Table component - displays league standings
//- Usage: +standingsTable(teams, { variant: 'widget' })
//- Variants: widget (compact), full (all columns), mini (minimal), sidebar (medium)
//- Options: userTeamId, showMedals, showCutoff, showPlayoffStats, isFinal
mixin standingsTable(teams, opts)
	- var options = opts || {}
	- var variant = options.variant || 'widget'
	- var showMedals = options.showMedals !== false && options.isFinal
	- var showCutoff = options.showCutoff !== false
	- var showPlayoffStats = options.showPlayoffStats || false
	-
		var variantClass = 'standings-table--' + variant
		var columns = {
			widget: ['rank', 'name', 'record', 'pf', 'pa'],
			sidebar: ['rank', 'name', 'record', 'allPlay', 'pf', 'pa'],
			full: ['rank', 'name', 'record', 'allPlay', 'stern', 'pf', 'pa', 'diff'],
			mini: ['rank', 'name', 'record']
		}
		// Seed badges removed - rank column serves same purpose in standings context
		var cols = columns[variant] || columns.widget
	div.standings-table-container(class=variantClass)
		table.table.standings-table.mb-0
			if variant !== 'mini'
				thead
					tr
						if cols.includes('rank')
							th.standings-table__col-rank
						if cols.includes('name')
							th.standings-table__col-name Team
						if cols.includes('record')
							th.standings-table__col-record.text-right Record
						if cols.includes('allPlay')
							th.standings-table__col-allplay.text-right All-Play
						if cols.includes('stern')
							th.standings-table__col-stern.text-right Stern
						if cols.includes('pf')
							th.standings-table__col-pf.text-right PF
						if cols.includes('pa')
							th.standings-table__col-pa.text-right PA
						if cols.includes('diff')
							th.standings-table__col-diff.text-right +/-
			tbody
				each team, idx in teams
					-
						var rowClasses = []
						if (showMedals) {
							if (idx === 0) rowClasses.push('standings-table__row--gold')
							else if (idx === 1) rowClasses.push('standings-table__row--silver')
							else if (idx === 2) rowClasses.push('standings-table__row--bronze')
						}
						if (showCutoff && idx === 3) rowClasses.push('standings-table__row--cutoff')
						var isUserTeam = (options.userTeamId && team.franchiseId === options.userTeamId) || (options.userTeamIds && options.userTeamIds.includes(team.franchiseId)) || (options.userTeamName && team.name === options.userTeamName)
						if (isUserTeam) rowClasses.push('standings-table__row--user')
						if (team.isPlayoffTeam) rowClasses.push('standings-table__row--playoff')
						if (variant === 'mini' && idx === 0) rowClasses.push('standings-table__row--winner')
					tr(class=rowClasses.join(' '))
						if cols.includes('rank')
							td.standings-table__rank= (variant === 'mini') ? (idx + 1) : (team.rank || idx + 1)
						if cols.includes('name')
							td.standings-table__name
								= team.name
								if team.divisionWinner
									span.standings-table__badge.standings-table__badge--div D
								if team.wildCard
									span.standings-table__badge.standings-table__badge--wc WC
						if cols.includes('record')
							td.standings-table__record.text-right
								= formatRecord(team.wins, team.losses, team.ties)
								if showPlayoffStats && team.isPlayoffTeam
									br
									span.standings-table__playoff-stat= team.playoffWins + '-' + team.playoffLosses
						if cols.includes('allPlay')
							td.standings-table__allplay.text-right
								if team.allPlay
									= formatRecord(team.allPlay.wins, team.allPlay.losses, team.allPlay.ties)
									if showPlayoffStats && team.isPlayoffTeam
										br
										span.standings-table__playoff-stat —
						if cols.includes('stern')
							td.standings-table__stern.text-right
								if team.stern
									= formatRecord(team.stern.wins, team.stern.losses, team.stern.ties)
									if showPlayoffStats && team.isPlayoffTeam
										br
										span.standings-table__playoff-stat —
						if cols.includes('pf')
							td.standings-table__pf.text-right
								= formatPoints(team.pointsFor)
								if showPlayoffStats && team.isPlayoffTeam
									br
									span.standings-table__playoff-stat= formatPoints(team.playoffPointsFor)
						if cols.includes('pa')
							td.standings-table__pa.text-right
								= formatPoints(team.pointsAgainst)
								if showPlayoffStats && team.isPlayoffTeam
									br
									span.standings-table__playoff-stat= formatPoints(team.playoffPointsAgainst)
						if cols.includes('diff')
							-
								var diff = team.pointsFor - team.pointsAgainst
								var diffClass = diff >= 0 ? 'text-success' : 'text-danger'
							td.standings-table__diff.text-right(class=diffClass)
								= (diff >= 0 ? '+' : '') + formatPoints(diff)
								if showPlayoffStats && team.isPlayoffTeam
									-
										var playoffDiff = team.playoffPointsFor - team.playoffPointsAgainst
										var playoffDiffClass = playoffDiff >= 0 ? 'text-success' : 'text-danger'
									br
									span.standings-table__playoff-stat(class=playoffDiffClass)
										= (playoffDiff >= 0 ? '+' : '') + formatPoints(playoffDiff)

//- Matchup component - displays a game between two teams
//- Usage: +matchup(game) or +matchup(game, { label: 'Semifinal 1' })
//- Game: { away: { name, score, record, seed, subtitle, won }, home: {...}, type }
//- Types: regular, semifinal, championship, thirdPlace
//- Options: label (string) - display a label above the matchup
//- subtitle: optional secondary text (e.g., regime name when showing franchise names)
mixin matchup(game, opts)
	- var options = opts || {}
	- var gameType = game.type || 'regular'
	- var hasScores = game.away.score != null && game.home.score != null
	- var hasSubtitle = game.away.subtitle || game.home.subtitle
	div.matchup(class='matchup--' + gameType class=hasSubtitle ? 'matchup--has-subtitle' : '')
		if options.label
			div.matchup__label= options.label
		div.matchup__teams
			div.matchup__team(class={ 'matchup__team--winner': game.away.won, 'matchup__team--loser': game.home.won })
				div.matchup__team-info
					if game.away.seed
						span.matchup__seed ##{game.away.seed}
					div.matchup__team-name-group
						span.matchup__name= game.away.name
						if game.away.record
							span.matchup__record (#{game.away.record})
						if game.away.subtitle
							span.matchup__subtitle= game.away.subtitle
				if hasScores
					div.matchup__result
						span.matchup__score= formatScore(game.away.score)
						i.fa.fa-chevron-left.matchup__chevron
			div.matchup__team(class={ 'matchup__team--winner': game.home.won, 'matchup__team--loser': game.away.won })
				div.matchup__team-info
					if game.home.seed
						span.matchup__seed ##{game.home.seed}
					div.matchup__team-name-group
						span.matchup__name= game.home.name
						if game.home.record
							span.matchup__record (#{game.home.record})
						if game.home.subtitle
							span.matchup__subtitle= game.home.subtitle
				if hasScores
					div.matchup__result
						span.matchup__score= formatScore(game.home.score)
						i.fa.fa-chevron-left.matchup__chevron

//- Franchise card for league overview and franchises list
//- Usage: +franchiseCard(franchise, { rosterLimit, isOffseason, standingsSeason })
mixin franchiseCard(franchise, opts)
	- var rosterLimit = opts.rosterLimit || 25
	- var isOffseason = opts.isOffseason || false
	- var standingsSeason = opts.standingsSeason || null
	div.card.h-100.franchise-card
		div.card-header.franchise-card__header
			div.franchise-card__title
				span.franchise-card__name= franchise.displayName
				if franchise.record
					span.franchise-card__record
						if isOffseason && standingsSeason
							span.franchise-card__record-season= standingsSeason + ': '
						| #{formatRecord(franchise.record.wins, franchise.record.losses, franchise.record.ties)} · #{ordinal(franchise.record.rank)}
		div.card-body.franchise-card__body
			- var pc = franchise.positionCounts || {}
			- var sc = franchise.salaryCounts || {}
			
			div.franchise-card__stat
				span.franchise-card__label Roster
				span.franchise-card__value #{franchise.rosterCount}/#{rosterLimit}
			- var unusedSpots = rosterLimit - franchise.rosterCount
			div.franchise-card__bar
				if pc.QB > 0
					div.franchise-card__pos-segment.franchise-card__pos-segment--qb(style='flex: ' + pc.QB, title='QB: ' + pc.QB)
				if pc.RB > 0
					div.franchise-card__pos-segment.franchise-card__pos-segment--rb(style='flex: ' + pc.RB, title='RB: ' + pc.RB)
				if pc.WR > 0
					div.franchise-card__pos-segment.franchise-card__pos-segment--wr(style='flex: ' + pc.WR, title='WR: ' + pc.WR)
				if pc.TE > 0
					div.franchise-card__pos-segment.franchise-card__pos-segment--te(style='flex: ' + pc.TE, title='TE: ' + pc.TE)
				if pc.IDP > 0
					div.franchise-card__pos-segment.franchise-card__pos-segment--idp(style='flex: ' + pc.IDP, title='IDP: ' + pc.IDP)
				if pc.K > 0
					div.franchise-card__pos-segment.franchise-card__pos-segment--k(style='flex: ' + pc.K, title='K: ' + pc.K)
				if unusedSpots > 0
					div.franchise-card__bar-unused(style='flex: ' + unusedSpots, title='Open: ' + unusedSpots)
			div.franchise-card__stat
				span.franchise-card__label Payroll
				span.franchise-card__value= formatMoney(franchise.payroll)
			div.franchise-card__bar
				if sc.QB > 0
					div.franchise-card__salary-segment.franchise-card__salary-segment--qb(style='flex: ' + sc.QB, title='QB: $' + sc.QB)
				if sc.RB > 0
					div.franchise-card__salary-segment.franchise-card__salary-segment--rb(style='flex: ' + sc.RB, title='RB: $' + sc.RB)
				if sc.WR > 0
					div.franchise-card__salary-segment.franchise-card__salary-segment--wr(style='flex: ' + sc.WR, title='WR: $' + sc.WR)
				if sc.TE > 0
					div.franchise-card__salary-segment.franchise-card__salary-segment--te(style='flex: ' + sc.TE, title='TE: $' + sc.TE)
				if sc.IDP > 0
					div.franchise-card__salary-segment.franchise-card__salary-segment--idp(style='flex: ' + sc.IDP, title='IDP: $' + sc.IDP)
				if sc.K > 0
					div.franchise-card__salary-segment.franchise-card__salary-segment--k(style='flex: ' + sc.K, title='K: $' + sc.K)
				if franchise.available > 0
					div.franchise-card__bar-unused(style='flex: ' + franchise.available, title='Available: $' + franchise.available)
			div.franchise-card__stat
				span.franchise-card__label Available
				span.franchise-card__value= formatMoney(franchise.available)
			if franchise.nextDraftPickCount > 0
				div.franchise-card__stat
					span.franchise-card__label #{franchise.nextDraftSeason} Draft
					span.franchise-card__value #{franchise.nextDraftPickCount} pick#{franchise.nextDraftPickCount !== 1 ? 's' : ''}
			if isOffseason && franchise.rfaCount > 0
				div.franchise-card__stat
					span.franchise-card__label RFA Rights
					span.franchise-card__value= franchise.rfaCount
		a.card-footer-link(href='/franchises/' + franchise.rosterId)
			span View Franchise
			i.fa.fa-chevron-right
